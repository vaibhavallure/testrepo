var BraintreeApplePayExpress=Class.create(BraintreeExpressAbstract,{vzeroApplePay:!1,_init:function(){if(!window.ApplePaySession||window.ApplePaySession&&!ApplePaySession.canMakePayments())return!1;this.vzeroApplePay=new vZeroApplePay(!1,this.storeFrontName,!1,!1,this.urls.clientTokenUrl),this.selectedMethod=!1,this.amount=!1,this.items=[],this.initOverlay()},initOverlay:function(){0==$$(".apple-pay-loading-overlay").length&&$$("body").first().insert('<div class="apple-pay-loading-overlay"><div class="ball-scale-ripple-multiple"><div></div><div></div><div></div></div></div>')},setLoading:function(){$$(".apple-pay-loading-overlay").first().addClassName("active")},resetLoading:function(){$$(".apple-pay-loading-overlay").first().removeClassName("active")},setAmount:function(t){this.amount=t,this.vzeroApplePay.amount=t},attachToButtons:function(t){if(!window.ApplePaySession||window.ApplePaySession&&!ApplePaySession.canMakePayments())return t.each(function(t){t.hide()}),!1;var e={validate:this.validateForm,onSuccess:function(t,e){return!1!==this.selectedMethod||void 0!==this.config.virtual&&this.config.virtual?this.submitApplePay(t.nonce,e.payment.shippingContact,e.payment.billingContact,this.selectedMethod):(alert("We're unable to ship to the address you've selected. You have not been charged."),!1)}.bind(this),paymentRequest:{requiredShippingContactFields:["postalAddress","email","phone"],requiredBillingContactFields:["postalAddress"]},onShippingContactSelect:this.onShippingContactSelect.bind(this),onShippingMethodSelect:this.onShippingMethodSelect.bind(this)};void 0!==this.config.virtual&&this.config.virtual&&(e.paymentRequest.requiredShippingContactFields=["email"]),t.each(function(t){t.up().addClassName("braintree-applepay-express-container")}),this.vzeroApplePay.attachApplePayEvent(t,e)},submitApplePay:function(t,e,i,s){var n={nonce:t,shippingAddress:Object.toJSON(e),billingAddress:Object.toJSON(i),shippingMethod:s};void 0!==this.config.productId&&(n.productId=this.config.productId,n.productForm=$("product_addtocart_form")?$("product_addtocart_form").serialize():$("pp_express_form").serialize()),this.setLoading(),new Ajax.Request(this.urls.submitUrl,{method:"POST",parameters:n,onSuccess:function(t){var e=this._parseTransportAsJson(t);1==e.success?window.location=this.urls.successUrl:e.message?(this.resetLoading(),alert(e.message)):(this.resetLoading(),alert("An unknown issue has occurred whilst processing your Apple Pay payment."))}.bind(this),onFailure:function(){this.resetLoading(),alert("An unknown issue has occurred whilst processing your Apple Pay payment.")}.bind(this)})},onShippingContactSelect:function(t,e,o){var i=t.shippingContact;void 0!==this.config.productId&&(i.productId=this.config.productId,i.productForm=$("product_addtocart_form")?$("product_addtocart_form").serialize():$("pp_express_form").serialize()),new Ajax.Request(this.urls.fetchMethodsUrl,{method:"POST",parameters:i,onSuccess:function(t){var e=this._parseTransportAsJson(t);if(1==e.success){var i=[],s=[],n=!1;e.total&&this.setAmount(parseFloat(e.total).toFixed(2)),this.items=[],e.items&&e.items.each(function(t){t.label&&t.amount&&(this.items.push(t),s.push({type:"final",label:t.label,amount:parseFloat(t.amount).toFixed(2)}))}.bind(this)),0<e.rates.length&&(e.rates.sort(function(t,e){return t.amount>e.amount?1:e.amount>t.amount?-1:0}),e.rates.each(function(t,e){t.amount=parseFloat(t.amount).toFixed(2),i.push(t)}),n=i[0],this.selectedMethod=n.identifier,s.push({type:"final",label:"Shipping",amount:parseFloat(n.amount).toFixed(2)}));var a={label:this.storeFrontName,amount:parseFloat(parseFloat(this.amount)+(n?parseFloat(n.amount):0)).toFixed(2)};0<i.length?o.completeShippingContactSelection(ApplePaySession.STATUS_SUCCESS,i,a,s):o.completeShippingContactSelection(ApplePaySession.STATUS_INVALID_SHIPPING_POSTAL_ADDRESS,i,a,s)}}.bind(this),onFailure:function(){o.abort(),alert(Translator.translate("An error was encountered whilst trying to determine shipping rates for your order."))}})},onShippingMethodSelect:function(t,e,i){var s=t.shippingMethod;this.selectedMethod=s.identifier;var n={label:this.storeFrontName,amount:parseFloat(parseFloat(this.amount)+parseFloat(s.amount)).toFixed(2)},a=[];this.items&&this.items.each(function(t){t.label&&t.amount&&a.push({type:"final",label:t.label,amount:t.amount})}.bind(this)),a.push({type:"final",label:"Shipping",amount:s.amount}),i.completeShippingMethodSelection(ApplePaySession.STATUS_SUCCESS,n,a)},_parseTransportAsJson:function(transport){try{return transport.responseJSON&&"object"==typeof transport.responseJSON?transport.responseJSON:transport.responseText?"object"==typeof JSON&&"function"==typeof JSON.parse?JSON.parse(transport.responseText):eval("("+transport.responseText+")"):{}}catch(t){return!1}}});