var vZero=Class.create();vZero.prototype={initialize:function(e,t,i,n,r,s,o,a,d){this.code=e,this.clientToken=t||!1,this.clientTokenUrl=d,this.threeDSecure=i,this.hostedFields=n,r&&(this.billingName=r),s&&(this.billingPostcode=s),this.billingCountryId=!1,o&&(this.quoteUrl=o),a&&(this.tokenizeUrl=a),this._hostedFieldsTokenGenerated=!1,this.acceptedCards=!1,this._hostedFieldsTimeout=!1,this._updateDataCallbacks=[],this._updateDataTimeout=null,this.client=!1,this.threeDSpecificCountries=!1,this.threeDCountries=[],this.threeDSecureFailedAction=0,this.supportedCards=[],this.cardType=!1,this.initEvents()},initEvents:function(){this.events={onBeforeUpdateData:[],onAfterUpdateData:[],onHandleAjaxRequest:[],integration:{onInit:[],onInitDefaultMethod:[],onInitSavedMethods:[],onShowHideOtherMethod:[],onCheckSavedOther:[],onPaymentMethodSwitch:[],onReviewInit:[],onBeforeSubmit:[],onAfterSubmit:[],onObserveAjaxRequests:[]}}},setKount:function(e,t){this.kountEnvironment=e,""!=t&&(this.kountId=t)},setSupportedCards:function(e){"string"==typeof e&&(e=e.split(",")),this.supportedCards=e},setThreeDCountries:function(e){"string"==typeof e&&(e=e.split(",")),this.threeDSpecificCountries=!0,this.threeDCountries=e},setThreeDFailedAction:function(e){this.threeDSecureFailedAction=e},observeEvent:function(e,i,n){Array.isArray(e)||(e=[e]),e.each(function(e){var t=this._resolveEvent(e);void 0===t?console.warn("Event for "+e+" does not exist."):t.push({fn:i,params:n})}.bind(this))},fireEvent:function(t,e,i){var n=this._resolveEvent(e);void 0!==n&&0<n.length&&n.each(function(e){if("function"==typeof e.fn){var arguments=[i];"object"==typeof e.params&&arguments.push(e.params),e.fn.apply(t,arguments)}})},_resolveEvent:function(e){return e.split(".").reduce(function(e,t){return e?e[t]:void 0},this.events)},getClientToken:function(i){return!1!==this.clientToken?i(this.clientToken):window.braintreeClientToken?i(window.braintreeClientToken):void new Ajax.Request(this.clientTokenUrl,{method:"get",onSuccess:function(e){if(e&&(e.responseJSON||e.responseText)){var t=this._parseTransportAsJson(e);if(1==t.success&&"string"==typeof t.client_token)return this.clientToken=t.client_token,window.braintreeClientToken=t.client_token,i(this.clientToken);console.error("We were unable to retrieve a client token from the server to initialize the Braintree flow."),t.error&&console.error(t.error)}}.bind(this),onFailure:function(){console.error("We were unable to retrieve a client token from the server to initialize the Braintree flow.")}.bind(this)})},getClient:function(i){!1!==this.client?"function"==typeof i&&i(this.client):this.getClientToken(function(e){braintree.client.create({authorization:e},function(e,t){e?console.error(e):(this.client=t,i(this.client))}.bind(this))})},initHostedFields:function(e){return!(0<$$('iframe[name^="braintree-"]').length)&&(null!==$("braintree-hosted-submit")&&(this.integration=e,this._hostedFieldsTokenGenerated=!1,clearTimeout(this._hostedFieldsTimeout),void(this._hostedFieldsTimeout=setTimeout(function(){if(!1!==this._hostedIntegration)try{this._hostedIntegration.teardown(function(){this._hostedIntegration=!1,this.setupHostedFieldsClient()}.bind(this))}catch(e){this.setupHostedFieldsClient()}else this.setupHostedFieldsClient()}.bind(this),50))))},teardownHostedFields:function(e){void 0!==this._hostedIntegration&&!1!==this._hostedIntegration?this._hostedIntegration.teardown(function(){this._hostedIntegration=!1,"function"==typeof e&&e()}.bind(this)):"function"==typeof e&&e()},setupHostedFieldsClient:function(){if(0<$$('iframe[name^="braintree-"]').length)return!1;this._hostedIntegration=!1,this.checkSubmitAfterPayment(),this.getClient(function(e){var t={client:e,styles:this.getHostedFieldsStyles(),fields:{number:{selector:"#card-number",placeholder:"0000 0000 0000 0000"},expirationMonth:{selector:"#expiration-month",placeholder:"MM"},expirationYear:{selector:"#expiration-year",placeholder:"YY"}}};null!==$("cvv")&&(t.fields.cvv={selector:"#cvv"}),braintree.hostedFields.create(t,function(e,t){if(!e)return this.hostedFieldsOnReady(t);"HOSTED_FIELDS_FIELD_DUPLICATE_IFRAME"!=e.code&&console.error(e)}.bind(this))}.bind(this))},hostedFieldsOnReady:function(e){this._hostedIntegration=e,$$("#credit-card-form.loading").length&&$$("#credit-card-form.loading").first().removeClassName("loading"),this.checkSubmitAfterPayment(),e.on("cardTypeChange",this.hostedFieldsCardTypeChange.bind(this))},checkSubmitAfterPayment:function(){if(this.integration.submitAfterPayment){if(null==$("braintree-submit-after-payment")){var e=new Element("input",{type:"hidden",name:"payment[submit_after_payment]",value:1,id:"braintree-submit-after-payment"});$("payment_form_gene_braintree_creditcard").insert(e)}}else $("braintree-submit-after-payment")&&$("braintree-submit-after-payment").remove()},getHostedFieldsStyles:function(){return"function"==typeof this.integration.getHostedFieldsStyles?this.integration.getHostedFieldsStyles():{input:{"font-size":"14pt",color:"#3A3A3A"},":focus":{color:"black"},".valid":{color:"green"},".invalid":{color:"red"}}},hostedFieldsCardTypeChange:function(e){if(void 0!==e.cards){var t={visa:"VI","american-express":"AE","master-card":"MC",discover:"DI",jcb:"JCB",maestro:"ME"};e.cards[0].type,this.cardType=t[e.cards[0].type],this.updateCardType(!1,this.cardType),-1==this.supportedCards.indexOf(this.cardType)?this.showCardUnsupported():this.removeCardUnsupported()}},showCardUnsupported:function(){if(0<$$(".braintree-card-input-field").length){var e=$$(".braintree-card-input-field").first().up();if(0==e.select(".braintree-card-unsupported").length){var t=new Element("div",{class:"braintree-card-unsupported"}).update(Translator.translate("We're currently unable to process this card type, please try another card or payment method."));e.insert(t)}}},removeCardUnsupported:function(){0<$$(".braintree-card-unsupported").length&&$$(".braintree-card-unsupported").each(function(e){e.remove()})},getBillingCountryId:function(){if(null==$("billing-address-select")||""==$("billing-address-select").value){var e=this.getBillingAddress();if(void 0!==e["billing[country_id]"])return e["billing[country_id]"]}return!!this.billingCountryId&&this.billingCountryId},shouldInvokeThreeDSecure:function(){var e;if(this.threeDSpecificCountries&&0<this.threeDCountries.length&&(e=this.getBillingCountryId()))return-1!==this.threeDCountries.indexOf(e);return this.threeDSecure},hostedFieldsNonceReceived:function(e,t){this.shouldInvokeThreeDSecure()?("function"==typeof this.integration.setLoading&&this.integration.setLoading(),this.verify3dSecureNonce(e.nonce,{onSuccess:function(e){this.updateNonce(e.nonce),"function"==typeof t.onSuccess&&t.onSuccess()}.bind(this),onFailure:function(){"function"==typeof t.onFailure&&t.onFailure()}.bind(this)})):(this.updateNonce(e.nonce),"function"==typeof t.onSuccess&&t.onSuccess())},updateNonce:function(e){$("creditcard-payment-nonce").value=e,$("creditcard-payment-nonce").setAttribute("value",e),"function"==typeof this.integration.resetLoading&&this.integration.resetLoading(),this._hostedFieldsTokenGenerated=!0},hostedFieldsError:function(e){return"function"==typeof this.integration.resetLoading&&this.integration.resetLoading(),void 0!==e.message&&-1==e.message.indexOf("Cannot place two elements in")&&-1==e.message.indexOf("Unable to find element with selector")&&-1==e.message.indexOf("User did not enter a payment method")&&alert(e.message),this._hostedFieldsTokenGenerated=!1,"function"==typeof this.integration.afterHostedFieldsError&&this.integration.afterHostedFieldsError(e.message),!1},usingSavedCard:function(){return null!=$("creditcard-saved-accounts")&&null!=$$("#creditcard-saved-accounts input:checked[type=radio]").first()&&"other"!==$$("#creditcard-saved-accounts input:checked[type=radio]").first().value},usingSavedThreeDCard:function(){return this.usingSavedCard()&&$$("#creditcard-saved-accounts input:checked[type=radio]").first().hasAttribute("data-threedsecure-nonce")},setThreeDSecure:function(e){this.threeDSecure=e},setAmount:function(e){this.amount=parseFloat(e)},setBillingName:function(e){this.billingName=e},getBillingName:function(){return"object"==typeof this.billingName?this.combineElementsValues(this.billingName):this.billingName},setBillingPostcode:function(e){this.billingPostcode=e},getBillingPostcode:function(){if("string"==typeof this.billingPostcode)return this.billingPostcode;if("object"==typeof this.billingPostcode)return this.combineElementsValues(this.billingPostcode);var e=this.getBillingAddress();return void 0!==e["billing[postcode]"]?e["billing[postcode]"]:null},setAcceptedCards:function(e){this.acceptedCards=e},getBillingAddress:function(){if("function"==typeof this.integration.getBillingAddress)return this.integration.getBillingAddress();var e={};return null!==$("co-billing-form")?e="FORM"==$("co-billing-form").tagName?$("co-billing-form").serialize(!0):this.extractBilling($("co-billing-form").up("form").serialize(!0)):null!==$("billing:firstname")&&(e=this.extractBilling($("billing:firstname").up("form").serialize(!0))),e||void 0},extractBilling:function(e){var t={};return $H(e).each(function(e){0==e.key.indexOf("billing")&&-1==e.key.indexOf("password")&&(t[e.key]=e.value)}),t},getShippingAddress:function(){if("function"==typeof this.integration.getShippingAddress)return this.integration.getShippingAddress();var e={};return null!==$("co-shipping-form")?e="FORM"==$("co-shipping-form").tagName?$("co-shipping-form").serialize(!0):this.extractShipping($("co-shipping-form").up("form").serialize(!0)):null!==$("shipping:firstname")&&(e=this.extractShipping($("shipping:firstname").up("form").serialize(!0))),e||void 0},extractShipping:function(e){var t={};return $H(e).each(function(e){0===e.key.indexOf("shipping")&&-1===e.key.indexOf("password")&&(t[e.key]=e.value)}),t},getAcceptedCards:function(){return this.acceptedCards},combineElementsValues:function(e,t){t=t||" ";var i=[];return e.each(function(e,t){void 0!==$(e)&&(i[t]=$(e).value)}),i.join(t)},updateCardType:function(e,t){if(null!=$("card-type-image")){var i=$("card-type-image").src.substring(0,$("card-type-image").src.lastIndexOf("/"));$("card-type-image").setAttribute("src",i+"/"+t+".png")}},observeAjaxRequests:function(n,r){if(vZero.prototype.observingAjaxRequests)return!1;vZero.prototype.observingAjaxRequests=!0,Ajax.Responders.register({onComplete:function(e){return this.handleAjaxRequest(e.url,n,r)}.bind(this)}),window.jQuery&&jQuery(document).ajaxComplete(function(e,t,i){return this.handleAjaxRequest(i.url,n,r)}.bind(this))},handleAjaxRequest:function(t,e,i){if(void 0!==i&&i instanceof Array&&0<i.length){var n=!1;if(i.each(function(e){t&&-1!=t.indexOf(e)&&(n=!0)}),!0===n)return!1}t&&-1==t.indexOf("/braintree/")&&(this.fireEvent(this,"onHandleAjaxRequest",{url:t}),e?e(t):this.updateData())},updateData:function(e,t){this._updateDataCallbacks.push(e),clearTimeout(this._updateDataTimeout),this._updateDataTimeout=setTimeout(function(){var i=this._updateDataCallbacks;this._updateDataCallbacks=[],this.fireEvent(this,"onBeforeUpdateData",{params:t}),new Ajax.Request(this.quoteUrl,{method:"post",parameters:t,onSuccess:function(e){if(e&&(e.responseJSON||e.responseText)){var t=this._parseTransportAsJson(e);null!=t.billingName&&(this.billingName=t.billingName),null!=t.billingPostcode&&(this.billingPostcode=t.billingPostcode),null!=t.billingCountryId&&(this.billingCountryId=t.billingCountryId),null!=t.grandTotal&&(this.amount=t.grandTotal),null!=t.threeDSecure&&this.setThreeDSecure(t.threeDSecure),"undefined"!=typeof vzeroPaypal&&null!=t.grandTotal&&null!=t.currencyCode&&vzeroPaypal.setPricing(t.grandTotal,t.currencyCode),0<i.length&&i.each(function(e){e(t)}.bind(this)),this.fireEvent(this,"onAfterUpdateData",{response:t})}}.bind(this),onFailure:function(){}.bind(this)})}.bind(this),250)},tokenize3dSavedCards:function(i){if(this.threeDSecure)if(void 0!==$$("[data-token]").first()){var n=[];$$("[data-token]").each(function(e,t){n[t]=e.getAttribute("data-token")}),new Ajax.Request(this.tokenizeUrl,{method:"post",onSuccess:function(e){if(e&&(e.responseJSON||e.responseText)){var t=this._parseTransportAsJson(e);t.success&&$H(t.tokens).each(function(e){null!=$$('[data-token="'+e.key+'"]').first()&&$$('[data-token="'+e.key+'"]').first().setAttribute("data-threedsecure-nonce",e.value)}),i&&i(t)}}.bind(this),parameters:{tokens:Object.toJSON(n)}})}else i();else i()},verify3dSecureNonce:function(a,d){this.getClient(function(e){braintree.threeDSecure.create({version:2,client:e},function(e,t){if(e)console.error(e);else{var i=this.getBillingAddress(),n=this.getShippingAddress(),r={givenName:i["billing[firstname]"],surname:i["billing[lastname]"],phoneNumber:i["billing[telephone]"]||"",streetAddress:void 0!==i["billing[street][]"]?i["billing[street][]"][0]:i["billing[street][0]"],extendedAddress:(void 0!==i["billing[street][]"]?i["billing[street][]"][1]:i["billing[street][1]"])||"",locality:i["billing[city]"],region:i["billing[region]"]||"",postalCode:i["billing[postcode]"],countryCodeAlpha2:i["billing[country_id]"]};if(0<Object.keys(n).length)var s={shippingGivenName:n["shipping[firstname]"],shippingSurname:n["shipping[lastname]"],shippingPhone:n["shipping[telephone]"]||"",shippingAddress:{streetAddress:void 0!==n["shipping[street][]"]?n["shipping[street][]"][0]:n["shipping[street][0]"],extendedAddress:(void 0!==n["shipping[street][]"]?n["shipping[street][]"][1]:n["shipping[street][1]"])||"",locality:n["shipping[city]"],region:n["shipping[region]"]||"",postalCode:n["shipping[postcode]"],countryCodeAlpha2:n["shipping[country_id]"]}};var o={amount:this.amount,nonce:a,billingAddress:r,additionalInformation:s||null,onLookupComplete:function(e,t){t()},addFrame:function(e,t){$$("#three-d-modal .bt-modal-body").first().insert(t),$("three-d-modal").removeClassName("hidden")},removeFrame:function(){$$("#three-d-modal .bt-modal-body iframe").first().remove(),$("three-d-modal").addClassName("hidden")}.bind(this)};t.verifyCard(o,function(e,t){e?d.onFailure&&d.onFailure(t,e):t.liabilityShifted?d.onSuccess&&d.onSuccess(t):"AE"===this.cardType?d.onSuccess&&d.onSuccess(t):1==this.threeDSecureFailedAction?d.onFailure&&d.onFailure(t,Translator.translate("Your payment has failed 3D secure verification, please try an alternate payment method.")):d.onSuccess&&d.onSuccess(t)}.bind(this))}}.bind(this))}.bind(this))},verify3dSecureVault:function(i){var e=$$("#creditcard-saved-accounts input:checked[type=radio]").first().getAttribute("data-threedsecure-nonce");e?this.verify3dSecureNonce(e,{onSuccess:function(e){$("creditcard-payment-nonce").removeAttribute("disabled"),$("creditcard-payment-nonce").value=e.nonce,$("creditcard-payment-nonce").setAttribute("value",e.nonce),"function"==typeof i.onSuccess&&i.onSuccess()},onFailure:function(e,t){alert(t),"function"==typeof i.onFailure?i.onFailure():checkout.setLoadWaiting(!1)}}):(alert("No payment nonce present."),"function"==typeof i.onFailure?i.onFailure():checkout.setLoadWaiting(!1))},processCard:function(i){var e=this.getBillingPostcode(),t={};e&&(t={billingAddress:{postalCode:e}}),this._hostedIntegration.tokenize(t,function(e,t){return e?("function"==typeof i.onFailure?i.onFailure():checkout.setLoadWaiting(!1),void("string"==typeof e.message&&alert(e.message))):this.hostedFieldsNonceReceived(t,i)}.bind(this))},shouldInterceptCreditCard:function(){return"0.00"!=this.amount},shouldInterceptPayPal:function(){return!0},process:function(e){if(e=e||{},!(this._hostedFieldsTokenGenerated||this.usingSavedCard()&&!this.usingSavedThreeDCard()))return this.usingSavedThreeDCard()?this.verify3dSecureVault(e):this.processCard(e);"function"==typeof e.onSuccess&&e.onSuccess()},creditCardLoaded:function(){return!1},paypalLoaded:function(){return!1},_parseTransportAsJson:function(transport){return transport.responseJSON&&"object"==typeof transport.responseJSON?transport.responseJSON:transport.responseText?"object"==typeof JSON&&"function"==typeof JSON.parse?JSON.parse(transport.responseText):eval("("+transport.responseText+")"):{}}},function(){function e(){}for(var t,i=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],n=i.length,r=window.console=window.console||{};n--;)r[t=i[n]]||(r[t]=e)}();