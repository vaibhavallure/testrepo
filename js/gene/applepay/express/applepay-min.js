var BraintreeApplePayExpress=Class.create(BraintreeExpressAbstract,{vzeroApplePay:!1,_init:function(){return!(!window.ApplePaySession||window.ApplePaySession&&!ApplePaySession.canMakePayments())&&(this.vzeroApplePay=new vZeroApplePay(!1,this.storeFrontName,!1,!1,this.urls.clientTokenUrl),this.selectedMethod=!1,this.amount=!1,this.items=[],void this.initOverlay())},initOverlay:function(){0==$$(".apple-pay-loading-overlay").length&&$$("body").first().insert('<div class="apple-pay-loading-overlay"><div class="ball-scale-ripple-multiple"><div></div><div></div><div></div></div></div>')},setLoading:function(){$$(".apple-pay-loading-overlay").first().addClassName("active")},resetLoading:function(){$$(".apple-pay-loading-overlay").first().removeClassName("active")},setAmount:function(e){this.amount=e,this.vzeroApplePay.amount=e},attachToButtons:function(e){if(!window.ApplePaySession||window.ApplePaySession&&!ApplePaySession.canMakePayments())return e.each(function(e){e.hide()}),!1;var t={validate:this.validateForm,onSuccess:function(e,t){return this.selectedMethod!==!1||"undefined"!=typeof this.config.virtual&&this.config.virtual?this.submitApplePay(e.nonce,t.payment.shippingContact,t.payment.billingContact,this.selectedMethod):(alert("We're unable to ship to the address you've selected. You have not been charged."),!1)}.bind(this),paymentRequest:{requiredShippingContactFields:["postalAddress","email","phone"],requiredBillingContactFields:["postalAddress"]},onShippingContactSelect:this.onShippingContactSelect.bind(this),onShippingMethodSelect:this.onShippingMethodSelect.bind(this)};"undefined"!=typeof this.config.virtual&&this.config.virtual&&(t.paymentRequest.requiredShippingContactFields=["email"]),e.each(function(e){e.up().addClassName("braintree-applepay-express-container")}),this.vzeroApplePay.attachApplePayEvent(e,t)},submitApplePay:function(e,t,i,s){var n={nonce:e,shippingAddress:Object.toJSON(t),billingAddress:Object.toJSON(i),shippingMethod:s};"undefined"!=typeof this.config.productId&&(n.productId=this.config.productId,n.productForm=$("product_addtocart_form")?$("product_addtocart_form").serialize():$("pp_express_form").serialize()),this.setLoading(),new Ajax.Request(this.urls.submitUrl,{method:"POST",parameters:n,onSuccess:function(e){var t=this._parseTransportAsJson(e);1==t.success?window.location=this.urls.successUrl:t.message?(this.resetLoading(),alert(t.message)):(this.resetLoading(),alert("An unknown issue has occurred whilst processing your Apple Pay payment."))}.bind(this),onFailure:function(){this.resetLoading(),alert("An unknown issue has occurred whilst processing your Apple Pay payment.")}.bind(this)})},onShippingContactSelect:function(e,t,i){var s=e.shippingContact,n=s;"undefined"!=typeof this.config.productId&&(n.productId=this.config.productId,n.productForm=$("product_addtocart_form")?$("product_addtocart_form").serialize():$("pp_express_form").serialize()),new Ajax.Request(this.urls.fetchMethodsUrl,{method:"POST",parameters:n,onSuccess:function(e){var t=this._parseTransportAsJson(e);if(1==t.success){var s=[],n=[],a=!1;t.total&&this.setAmount(parseFloat(t.total).toFixed(2)),this.items=[],t.items&&t.items.each(function(e){e.label&&e.amount&&(this.items.push(e),n.push({type:"final",label:e.label,amount:parseFloat(e.amount).toFixed(2)}))}.bind(this)),t.rates.length>0&&(t.rates.sort(function(e,t){return e.amount>t.amount?1:t.amount>e.amount?-1:0}),t.rates.each(function(e,t){e.amount=parseFloat(e.amount).toFixed(2),s.push(e)}),a=s[0],this.selectedMethod=a.identifier,n.push({type:"final",label:"Shipping",amount:parseFloat(a.amount).toFixed(2)}));var o={label:this.storeFrontName,amount:parseFloat(parseFloat(this.amount)+(a?parseFloat(a.amount):0)).toFixed(2)};i.completeShippingContactSelection(ApplePaySession.STATUS_SUCCESS,s,o,n)}}.bind(this),onFailure:function(){i.abort(),alert(Translator.translate("An error was encountered whilst trying to determine shipping rates for your order."))}})},onShippingMethodSelect:function(e,t,i){var s=e.shippingMethod;this.selectedMethod=s.identifier;var n={label:this.storeFrontName,amount:parseFloat(parseFloat(this.amount)+parseFloat(s.amount)).toFixed(2)},a=[];this.items&&this.items.each(function(e){e.label&&e.amount&&a.push({type:"final",label:e.label,amount:e.amount})}.bind(this)),a.push({type:"final",label:"Shipping",amount:s.amount}),i.completeShippingMethodSelection(ApplePaySession.STATUS_SUCCESS,n,a)},_parseTransportAsJson:function(transport){try{return transport.responseJSON&&"object"==typeof transport.responseJSON?transport.responseJSON:transport.responseText?"object"==typeof JSON&&"function"==typeof JSON.parse?JSON.parse(transport.responseText):eval("("+transport.responseText+")"):{}}catch(e){return!1}}});