<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/* @var Mage_Wishlist_Model_Item $item */
$item = $this->getItem();
$product = $item->getProduct();
$defaultProduct = $product;
$productUrl = $defaultProduct->getProductUrl();
if($product->getTypeId() =='configurable'){ 
    $attribute = $item->getBuyRequest()->getSuperAttribute(); 
    if(!$attribute){   
        $data  = $item->getBuyRequest()->getData('data');
        if($data){
            $requestParams = unserialize(base64_decode($data));
            $attribute =  $requestParams['super_attribute'];        
        }
    }
    if($attribute){      
        $product_id = $product->getEntityId();
        $resource = Mage::getSingleton('core/resource');
        $read = $resource->getConnection('core_read');
        $select = $read->select()
			->from(array('super' => $resource->getTableName('catalog_product_super_attribute')), array('super.product_id','super.attribute_id'))
			->join(array('eav' => $resource->getTableName('eav_attribute')),
			      'eav.attribute_id = super.attribute_id',
			      array('eav.attribute_code','eav.frontend_label'))
			    ->where('super.product_id = ?', $product_id);
     
        $result = $read->fetchAll($select);
        $resultAttribute = array();
        if(count($result)){
                foreach($result as $info){
                     $resultAttribute[] = $info['attribute_id'];                    
                }
        }   
        $check = @array_diff(@array_keys($attribute),$resultAttribute);
        if(count($check)){
            // Ignore images
        }else{  
            $prod =  Mage::getModel('catalog/product_type_configurable')->getProductByAttributes($attribute, $product);
            if($prod){
                $simpleId = $prod->getEnTityId();
                $product = Mage::getModel('catalog/product')->load($simpleId);
            }
            $option_id = null;
            foreach($item->getBuyRequest()->getSuperAttribute() as $id) {
                $option_id = $id; break;
            }
            $productUrl = $defaultProduct->getProductUrl().'?optionId='.$option_id;
        }
    }
}
?>
<td>
    <a class="product-image" href="<?php echo $productUrl; ?>" title="<?php echo $this->escapeHtml($product->getName()) ?>">
        <img src="<?php echo $this->helper('catalog/image')->init($product, 'thumbnail')->resize(75, 97); ?>" width="75" height="95" alt="<?php echo $this->escapeHtml($product->getName()) ?>" />
    </a>
</td>