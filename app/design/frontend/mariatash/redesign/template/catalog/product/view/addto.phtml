<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php $_product = $this->getProduct();
if($_product->isConfigurable()){
	$productModel=Mage::getModel("catalog/product");
	$conf = Mage::getModel('catalog/product_type_configurable')->setProduct($_product);
    $col = $conf->getUsedProductCollection()->addAttributeToSelect('*')->addFilterByRequiredOptions();
	$faveArr=array();
	 foreach($col as $sprod){
	 	$faveArr[$sprod->getId()]=$this->helper('wishlist')->getAddUrl($sprod);
	 }
	 $json_array =json_encode($faveArr);

		echo "<script>
			var faveArray= new Array();
			faveArray = ". $json_array . ";
			</script>\n";
}

?>
<script type="text/javascript">
    var wishlistForm = new VarienForm('product_addtocart_form');
    wishlistForm.submitAjaxWishlist = function (button, url, id) {
        if (this.validator) {
            var nv = Validation.methods;
            delete Validation.methods['required-entry'];
            delete Validation.methods['validate-one-required'];
            delete Validation.methods['validate-one-required-by-name'];
            if (this.validator.validate()) {
                url = url.replace('wishlist/index', 'ajaxwishlist/index')
                         .replace('https://', '//');
                var data = jQuery('#product_addtocart_form').serialize();
                data += '&isAjax=1';
                <?php /*?>jQuery('#ajax_loading').show();<?php */?>
                jQuery.ajax({
                    url: url,
                    dataType: 'json',
                    type: 'post',
                    data: data,
                    beforeSend: function() {  setLoader(); 
                    },
                    success: function (data) {
                        <?php /*?>jQuery('#ajax_loading').hide();<?php */?>
                        if (data.status == 'ERROR') {
                            if (data.message == 'login') {
                                <?php Mage::getSingleton('core/session')->setMywish('1');
                                    Mage::getSingleton('core/session')->setPwish('1');
                                ?>
                                console.log(data);

                                parent.jQuery("#sign_in_label").trigger('click');
                                parent.jQuery.fancybox.close();
                                jQuery('#fancybox-loading').css('display','none');
                                jQuery('.fancybox-overlay').css('display','none');

                            } else {
                                alert(data.message);
                            } 
                        } else {jQuery('#fancybox-loading').css('display','none');
                                jQuery('.fancybox-overlay').css('display','none');
                            jQuery('.faveSuccess').html(data.message).show();
                            setTimeout(function(){
                                jQuery('.faveSuccess').fadeOut(3000);
                            }, 3000);
                        }
                    }
                });
            }
            Object.extend(Validation.methods, nv);
        }
    }.bind(wishlistForm);
</script>
<script>
	jQuery.noConflict();
		function loadConfigurablesId(){
			var sizeAttributeId = jQuery('.attributeSelectIds#sizeAttribute').val();
			var colorAttributeId = jQuery('.attributeSelectIds#colorAttribute').val();
			var attributeColor = jQuery('#attribute' + colorAttributeId + ' option:selected').val();
			var attributeSize = jQuery('#attribute' + sizeAttributeId + ' option:selected').val();
			var productId = jQuery('#product-configurable-hidden').val();
			jQuery.get('<?php echo Mage::getBaseUrl();?>productview/index/loadAttributes/', { color : attributeColor, size : attributeSize, product : productId, colorId : colorAttributeId ,sizeId : sizeAttributeId }, function(data){
			     jQuery(location).attr('href','<?php echo Mage::getBaseUrl();?>wishlist/index/add/product/' + data);
			   });
		}
</script>

<?php $_wishlistSubmitUrl = $this->helper('wishlist')->getAddUrl($_product); ?>


<input type="hidden" value="<?php echo $_product->getId()?>" id="product-configurable-hidden" />
<ul class="add-to-links col-6 float-left">
<?php if ($this->helper('wishlist')->isAllow() && !Mage::helper("allure_catalog")->isGiftCard($_product->getId())) : ?>
    <li class="row justify-content-end"><a onclick="validateFave()" class="link-wishlist para-lighter text-umderline"><?php echo $this->__('Add to Wishlist') ?></a></li>
<span id='ajax_loading' style='display:none'><img src='<?php echo $this->getSkinUrl('images/opc-ajax-loader.gif')?>'/></span>
<div class='faveSuccess' style='display:none;'></div>
	<script type="text/javascript">
		function validateFave (){
            var hasErrors = false;
            if (jQuery('.ajax-error-messages')) {
                jQuery('.ajax-error-messages').remove();
            }
            jQuery('#product_addtocart_form .required-entry:not(.selectboxit)').each(function () {
                if (!jQuery(this).val()) {
                    hasErrors = true;
                    jQuery('<div class="ajax-error-messages"><?php echo $this->__('This field is required!'); ?></div>').insertAfter(jQuery(this).parent());
                }
            });
            if (hasErrors) {
                return false;
            }
			var pid = jQuery('#pid-hidden').val();

			//comment by allure
            //if (typeof spConfig<?php echo $_product->getId(); ?> == 'undefined') {
			//	wishlistForm.submitAjaxWishlist(this, '<?php echo $this->helper('wishlist')->getAddUrl($_product); ?>cpid/<?php echo $_product->getId()?>/product/'+pid +'/', '<?php echo $_product->getId()?>');
            //} else {
            //    wishlistForm.submitAjaxWishlist(this, faveArray[spConfig<?php echo $_product->getId(); ?>.getIdOfSelectedProduct()], spConfig<?php echo $_product->getId(); ?>.getIdOfSelectedProduct());
            //}

            //allure code
			wishlistForm.submitAjaxWishlist(this,'<?php echo $this->helper('wishlist')->getAddUrl($_product); ?>product/<?php echo $_product->getId()?>/', '<?php echo $_product->getId()?>' , jQuery('input[name="product"]').val());

		}
	</script>
<?php endif; ?>
<!-- <//?php
    $_compareUrl = $this->helper('catalog/product_compare')->getAddUrl($_product);
?>
<//?php if($_compareUrl) : ?>
    <li><span class="separator">|</span> <a href="<//?php echo $_compareUrl ?>" class="link-compare"><//?php echo $this->__('Add to Compare') ?></a></li>
<//?php endif; ?> -->
</ul>
