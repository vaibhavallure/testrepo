<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/* @var Mage_Wishlist_Model_Item $item */
$item = $this->getItem();
$_data = $item->getBuyRequest()->getData();
$product = $item->getProduct();

$cpid = ($product->getId() == $_data['cpid']) ? 0 : $_data['cpid'];
$defaultProduct  = $product;
$arrayOptions = array();
$productUrl = $defaultProduct->getProductUrl();
if($product->getTypeId() =='configurable'){
    $superAttribute = $item->getBuyRequest()->getSuperAttribute();
    foreach($superAttribute as $code => $option_id){
        $attribute = Mage::getModel('catalog/resource_eav_attribute')->load($code);
        $attribute_table = Mage::getModel('eav/entity_attribute_source_table')->setAttribute($attribute)->getAllOptions(false);
        foreach($attribute_table as $info){
            if($info['value'] == $option_id){
                $arrayOptions[$attribute->getFrontendLabel()] = $info['label'];
                break;
            }
        }
    }

    if(!$superAttribute){
        $data  = $item->getBuyRequest()->getData('data');
        if($data){
            $requestParams = unserialize(base64_decode($data));
            $superAttribute =  $requestParams['super_attribute'];
        }
    }
    if($superAttribute){
        $product_id = $product->getEntityId();
        $resource = Mage::getSingleton('core/resource');
        $read = $resource->getConnection('core_read');
        $select = $read->select()
        ->from(array('super' => $resource->getTableName('catalog_product_super_attribute')), array('super.product_id','super.attribute_id'))
        ->join(array('eav' => $resource->getTableName('eav_attribute')),
            'eav.attribute_id = super.attribute_id',
            array('eav.attribute_code','eav.frontend_label'))
        ->where('super.product_id = ?', $product_id);

        $result = $read->fetchAll($select);
        $resultAttribute = array();
        if(count($result)){
            foreach($result as $info){
                $resultAttribute[] = $info['attribute_id'];
            }
        }
        $check = @array_diff(@array_keys($superAttribute),$resultAttribute);
        if(count($check)){
            // Ignore images
        }else{

            $prod =  Mage::getModel('catalog/product_type_configurable')->getProductByAttributes($attribute, $product);
            if($prod){
                $simpleId = $prod->getEnTityId();
                $product = Mage::getModel('catalog/product')->load($simpleId);
            }

            $option_id = null;
            foreach($item->getBuyRequest()->getSuperAttribute() as $id) {
                $option_id = $id; break;
            }
            $productUrl = $defaultProduct->getProductUrl().'?optionId='.$option_id;
        }

    }
}
?>
<td class="product-w-mt wishlist-no-pad">
    <script>
        jQuery.noConflict();
        jQuery(document).ready(function () {
            jQuery('.ecp-wishlist-description').each(function(){
                var max = parseInt(jQuery(this).attr('maxlength'));
                jQuery(this).parent().find('.charsRemaining').html('You have ' + (max - jQuery(this).val().length) + ' characters left');
            });
            jQuery('textarea[maxlength]').keyup(function () {
                var max = parseInt(jQuery(this).attr('maxlength'));
                if (jQuery(this).val().length > max) {
                    jQuery(this).val(jQuery(this).val().substr(0, jQuery(this).attr('maxlength')));
                }

                jQuery(this).parent().find('.charsRemaining').html('You have ' + (max - jQuery(this).val().length) + ' characters left');
            });
        });

    </script>

    <h2 class="product-name para-normal">
        <a href="<?php echo $productUrl; ?>" title="<?php echo $this->escapeHtml($defaultProduct->getName()) ?>"><?php echo $this->escapeHtml($defaultProduct->getName()) ?></a>
    </h2>
    <div class="price-wish"><?php //echo $this->getPriceHtml($product); ?></div>
    <?php
    $helper = Mage::helper('catalog/product_configuration');
    if($item->getProduct()->getTypeId() == "configurable"):
        $_options = $helper->getConfigurableOptions($item);
    ?>
    <?php if ($_options):?>

        <div class="flex-box">

            <div class="item para-normal pr-3">
              <?php foreach ($_options as $_option) : ?>
                <?php echo $this->escapeHtml($_option['label'])=='Color'? 'Metal Color:': $this->escapeHtml($_option['label']).":" ?>
                <?php echo $_option['value'] ?>
                  <?= "<br>"?>
            <?php endforeach; ?>
        </div>

        <div class="item">
            <div class="flex-box">
                <div class="item">
                 <?php echo Mage::helper('core')->currency($item->getProduct()->getFinalPrice());?>
             </div>
             <div class="flex-box qty-wrap">
                 <?php if(0):?>
                    <input type="text" class="input-text qty validate-not-negative-number" name="qty[<?php echo $item->getId() ?>]" value="<?php echo (int) $item->getData('qty'); ?>"/>
                    <input type="hidden" class="item_id"value="<?php echo $item->getId() ?>"/>
                <?php endif;?>

                <div class="minus_icon" <?php if($item->getProductType() == 'customproduct') echo 'style="display:none;"'; ?>>
                    <button onclick="plusMinusToWishlist( '#qtyid_<?php echo $item->getId() ?>', -1 )" class="minus-btn" title="Update Shopping Cart" value="update_qty" name="update_cart_action" type="button"><span class="quantity-count">-</span></button>
                </div>
                <div class="qty-wrap">
                    <input data-item-id="<?php echo $item->getId() ?>" id="qtyid_<?php echo $item->getId() ?>" name="cart[<?php echo $item->getId() ?>][qty]" value="<?php echo (int) $item->getData('qty')?>" size="4" title="<?php echo $this->__('Qty') ?>" class="input-text qty" maxlength="12" <?php if($item->getProductType() == 'customproduct') echo 'readonly="readonly"'; ?> />
                    <input type="hidden" value="<?php echo (int) $item->getData('qty')?>"/>
                </div>
                <div class="plus_icon" <?php if($item->getProductType() == 'customproduct') echo 'style="display:none;"'; ?>>
                    <button onclick="plusMinusToWishlist( '#qtyid_<?php echo $item->getId() ?>', 1 )" class="plus-btn" title="Update Shopping Cart" value="update_qty" name="update_cart_action" type="button"><span class="quantity-count">+</span></button>
                </div>

            </div>
        </div>
    </div>
    <div class="item fprice">
       <?php echo Mage::helper('core')->currency((((int) $item->getData('qty')) * $item->getProduct()->getFinalPrice()))?>
   </div>
</div>

<?php endif;?>
<?php endif;?>
<div class="flex-box">
    <div class="item para-normal">
        <span class="mt-wishlist-added-at">
            <?php echo "Added ".date('M d, Y H:i a',strtotime($item->getAddedAt()))?>
        </span>
    </div>

</div>

</td>





<!-- <td class="mt-myaccount-subtotal">
    <?php echo Mage::helper('core')->currency((((int) $item->getData('qty')) * $item->getProduct()->getFinalPrice()))?>
</td> -->

<!--****-->

<!-- <td class="ad-wish-mt">
    <textarea placeholder="Please, enter your comments..." class="ecp-wishlist-description" name="description[<?php echo $item->getWishlistItemId() ?>]" rows="3"
              cols="5"  maxlength="45"
              title="<?php echo $this->__('Comment') ?>"><?php echo($this->escapeHtml($item->getDescription())) ?></textarea>

    <div class="charsRemaining">You have 45 characters left</div>
</td> -->

<?php if(0):?>
    <td class="date-wish">
        <span><?php echo date('m/d/y', strtotime($item->getAddedAt())); ?></span>
    </td>
<?php endif;?>

<?php if ($this->getSortedChildren()): ?>
    <div class="item-manage">
        <?php foreach ($this->getSortedChildren() as $childName): ?>
            <?php echo $this->getChildHtml($childName, false); ?>
        <?php endforeach; ?>
    </div>
<?php endif; ?>

