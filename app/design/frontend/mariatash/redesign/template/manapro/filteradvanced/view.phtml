<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     rwd_default
 * @copyright   Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http://www.magento.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * Category layered navigation
 *
 * @see Mage_Catalog_Block_Layer_View
 */
//debug_print_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS);


?>
<?php if($this->canShowBlock()): ?>
<?php if($this->getRequest()->getModuleName() == 'catalogsearch') { ?>
<div class="m-block mb-mana-catalogsearch-leftnav">
<?php }  else {
  $currentCategory = Mage::registry('current_category')
  ?>
  <div id="category-title" class="page-title category-title <?php echo ($currentCategory->getCategoryBleed()) ? ' category-bleed' : ''?>">
         <h1><?php echo $currentCategory->getName(); ?></h1>
 </div>
<?php } ?>
<div class="block-layered-nav-bg filter-common-div">
<div class="block block-layered-nav mb-mana-catalogsearch-leftnav">
    <!-- <div class="block-title">
        <strong><span><//?php echo $this->__('Narrow by:') ?></span></strong>
    </div> -->
    <div class="block-content">
      <div class="selected-filters">
      <?php //echo $this->getStateHtml() ?>

      </div>


        <?php if($this->canShowOptions()): ?>
            <input type="hidden" value="" name="selectedfilter" id="selectedfilter" />
            <p class="block-subtitle"><?php echo $this->__('Shopping Options') ?></p>
            <div class="allure_filter">
                <dt class="filter-head al-hide para-normal">Filter By</dt>
                <dd class="filter-contain al-hide" >
                    <ul id="narrow-by-list" class="mb-0">
                        <?php $_filters = $this->getFilters(); $i = 0; ?>
                        <?php foreach ($_filters as $_filter): ?>
                        <?php
                        if (!$_filter->getCode()) {
                            $_filterCode = iconv('utf-8', 'us-ascii//TRANSLIT', $_filter->getName());
                            $_filterCode = strtolower(preg_replace('/[^A-Za-z0-9-]+/', '_', $_filterCode));
                            $_filter->setCode($_filterCode);
                        }
                        ?>
                        <?php //echo (get_class($_filter));?>
                        <?php /*if($_filter->getItemsCount() && 'price' == $_filter->getCode()): */?><!--
                    <li class="common-filter filtru-<?php /*echo $_filter->getCode(); */?>">
                        <div class="optionfilter" style="<?php /*if($_filter->getCode() != 'price') : */?><?php /*endif; */?>">
                            <dt><?php /*echo $this->__($_filter->getName()) */?></dt>
                            <dd><li><?php /*echo $_filter->getHtml() */?></li></dd>
                        </div>
                    </li>
                --><?php /*endif; */?>
                        <?php if($_filter->getItemsCount() ): //&& 'price' != $_filter->getCode()?>
                        <li class="common-filter filtru-<?php echo $_filter->getCode().'-dtn'; ?>">
                            <div class="optionfilter" style="<?php if($_filter->getCode() != 'price') : ?><?php endif; ?>">
                <dt><?php echo $this->__($_filter->getName()) ?></dt>
                <dd data-filter-code="<?= $_filter->getCode() ?>" class="filtru-<?php echo $_filter->getCode().'-content-dtn'; ?>" style ="display:none">
                    <!-- <div class="filter_name"><//?php echo $this->__($_filter->getName()) ?></div> -->
                    <?php echo $_filter->getHtml() ?>
                </dd>
            </div>
        </li>
        <script type="text/javascript">
            jQuery(document).ready(function(){
                var config_currency_selector_<?php echo $_filter->getCode() ?> = {
                    over: function(){
                        //jQuery('.filtru-<?php echo $_filter->getCode() . '-content-dtn'; ?>').slideDown(300);
                    },
                    timeout: 200,
                    out: function(){
                        jQuery('.filtru-<?php echo $_filter->getCode() . '-content-dtn'; ?>').removeClass('show');
                        jQuery('.filtru-<?php echo $_filter->getCode() . '-content-dtn'; ?>').slideUp(300);
                    }
                };

                if (jQuery(window).width() > 1023) {
                    jQuery(".filtru-<?php echo $_filter->getCode() . '-dtn'; ?>").hoverIntent(config_currency_selector_<?php echo $_filter->getCode() ?> );
                }
                    jQuery('.filtru-<?php echo $_filter->getCode() . '-dtn'; ?> div dt').click(function () {
                    var showOrHide = jQuery('.filtru-<?php echo $_filter->getCode() . '-content-dtn'; ?>').hasClass('show');
                    if(!showOrHide) {
                        jQuery(this).addClass("showing");
                        jQuery('.filtru-<?php echo $_filter->getCode() . '-content-dtn'; ?>').addClass('show');
                        jQuery('.filtru-<?php echo $_filter->getCode() . '-content-dtn'; ?>').slideDown(300);
                    }
                    else {
                        jQuery(this).removeClass("showing");
                        jQuery("body").removeClass("fancybox-lock");
                        jQuery('.filtru-<?php echo $_filter->getCode() . '-content-dtn'; ?>').removeClass('show');
                        jQuery('.filtru-<?php echo $_filter->getCode() . '-content-dtn'; ?>').slideUp(300);
                    }
                });
            });
        </script>
    <?php endif; ?>
    <?php //if($i++ == 2) break?>
    <?php endforeach; ?>
        <?php if ($this->getLayer()->getState()->getFilters()): ?>
            <li class="filter-actions">
                <div class="actions" id="apply-filter-btn" ><a onclick="applyFilter()" class="link-button float-right"><?php echo $this->__('Apply') ?></a></div>
                <div class="actions" id="clear-all-filter"><a class="link-button" href="<?php echo $this->getClearUrl() ?>"><?php echo $this->__('Clear All') ?></a></div>
            </li>
            <?php else: ?>
            <li class="filter-actions">
                <div class="actions" id="apply-filter-btn" ><a onclick="applyFilter()" class="link-button float-right"><?php echo $this->__('Apply') ?></a></div>
                <div class="actions" id="clear-all-filter"><a class="link-button" href="#"><?php echo $this->__('Clear All') ?></a></div>
            </li>
        <?php endif; ?>
        <li id="total_item_counts_holder">
            <span class="info-text-two"></span>
        </li>
        </ul>
        </dd>
            </div>
<!--            --><?php //var_dump($this->getFiter()->getMSelectedValues())?>
            <script type="text/javascript">decorateDataList('narrow-by-list')</script>
        <?php endif; ?>


    </div>
</div>
</div>
<?php if($this->getRequest()->getModuleName() == 'catalogsearch') { ?>
</div>
<?php } ?>
<?php endif; ?>
<script>
	function customShowmore(obj) {
		var parent_class = jQuery(obj).parent().parent().attr('class');
		if(jQuery('#selectedfilter').val() == '') {
			jQuery('.'+parent_class+' .m-show-more-action').click();
		}
	}
    jQuery(document).ready(function() {

        jQuery('#narrow-by-list div.optionfilter').live('mouseleave', function(){
            if (jQuery(window).width() > 1023) {
                var parent_class = jQuery(this).parent().attr('class');
                if (jQuery('#selectedfilter').val() != '') {
                    jQuery('.' + parent_class + ' .m-show-less-action').click();
                }
            }
        });

        jQuery("#total_item_counts_holder span").html(jQuery("#total_item_counts").html());
    });


    jQuery('.allure_filter .filter-head').click(function () {
        if(!jQuery(".filter-head").hasClass("showing")) {
            jQuery(".filter-head").addClass("showing");
            jQuery(".filter-contain").slideDown();
            jQuery("body").css("overflow","hidden");
            jQuery(".allure_filter").addClass("scrolling");
            scrollToFilter();
        }else {
            jQuery(".filter-head").removeClass("showing");
            jQuery(".filter-contain").slideUp();
            jQuery("body").css("overflow","auto");
            jQuery(".allure_filter").removeClass("scrolling");
            unScrollToFilter();
        }
        });

    function scrollToFilter()
    {
        var block = jQuery(".filter-common-div");
        block.css("height", "100vh");
        block.css("overflow", "auto");
//        block.css("background", "transparent");
        block.css("padding-bottom","200px");

    }
    function unScrollToFilter()
    {
        var block = jQuery(".filter-common-div");
        block.css("height", "auto");
        block.css("overflow", "auto");
//        block.css("background", "white");
        block.css("padding-bottom","0");
    }


    jQuery(window).bind("resize load",function () {
        if (jQuery(window).width() <= 1023) {
            jQuery(".allure_filter .filter-contain").hide();
            jQuery(".allure_filter .filter-head").show();
        }else
        {
            jQuery(".allure_filter .filter-contain").show();
            jQuery(".allure_filter .filter-head").hide();
        }
        jQuery(".filter-contain").removeClass("al-hide");
        jQuery(".filter-head").removeClass("al-hide");

    });


    jQuery(window).bind("scroll resize load",function () {

    if (jQuery(window).width() <= 1023) {
        var scroll = jQuery(window).scrollTop();
        if (scroll > jQuery(".mariatash-header").outerHeight()) {
               jQuery(".top-bar").addClass("sticky-bar");
               jQuery(".filter-common-div").addClass("sticky-filter");
        } else {
            jQuery(".top-bar").removeClass("sticky-bar");
            jQuery(".filter-common-div").removeClass("sticky-filter");
        }
    }
    });



    function applyFilter() {
        if(jQuery(".filter-checkbox-input:checked").length) {
            var filters = {};

            <?php if($this->getRequest()->getControllerName()=="result"):?>
            var plainUrl="<?= explode("?",$this->getClearUrl())[0]?>";
            var tail="?<?= explode("?",$this->getClearUrl())[1]?>";

            <?php else: ?>
            var plainUrl="<?= $this->getClearUrl() ?>";
            var tail=".html";
            <?php endif ?>

            var controller="<?= $this->getRequest()->getControllerName(); ?>";
            jQuery(".filter-checkbox-input:checked").each(function () {
                var t = filters[jQuery(this).attr('data-var-name')];
                filters[jQuery(this).attr('data-var-name')] = [...t ? t : [], jQuery(this).attr('data-var-value')
            ];
            });

            var urlString=plainUrl.replace(".html","");
            for(var key in filters)
            {
                urlString+="/"+key+"/"+filters[key].join("-");
            }
            urlString+=tail;

//            console.log(urlString);

            window.location=urlString;
        }else {
            alert("No value selected for filter");
        }
    }
</script>
