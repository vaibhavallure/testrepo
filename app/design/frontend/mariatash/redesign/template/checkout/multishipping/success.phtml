<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2006-2019 Magento, Inc. (http://www.magento.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 * 
 * @var Mage_Checkout_Block_Multishipping_Success $this
 */
?>
<?php 
    $isChange = false;
    $_orderIds = $this->getOrderIds();
    if(Mage::helper("core")->isModuleEnabled("Allure_Orders")){
        foreach ($_orderIds as $orderId => $incrementId ){
            $order = Mage::getModel('sales/order')->load($orderId); 
            $storeId = $order->getStoreId();
            $isChange = Mage::helper("allure_orders")->isSuccessPageChange($storeId);
            break;
        }
    }
    
?>

<?php if($isChange):?>

<div class="multiple-checkout">
	<div class="page-title">
    	<h1 class="order-success-title text-center" data-role="page-title"><?php echo $this->__('Your order has been received') ?></h1>
    </div>
    <h2 class="sub-title info-text-two mb-4"><?php echo $this->__('Thank you for your purchase.') ?></h2>
    <p class="para-normal"><?php echo $this->__('You will receive an order confirmation email with details of your order and a link to track your progress.') ?></p>
<!--    <p class="para-normal">--><?php //echo $this->__('Due to COVID-19 and evolving government restrictions, your order may experience shipping and fulfillment delays.') ?><!--</p>-->
    <p class="para-normal"><?php echo $this->__('If you have any questions regarding your order, please visit our <a class="success-page-text-link-style" href="'.Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_WEB)."contact-us".'">Contact Us</a> page to connect with our customer support team.')?></p>
    
    <?php echo $this->getChildHtml() ?>
    <div class="buttons-set text-center mt-4">
        <button type="button" title="<?php echo Mage::helper('core')->quoteEscape($this->__('Continue Shopping')) ?>" class="button dark-button next-button" onclick="setLocation('<?php echo $this->getContinueUrl() ?>')"><span><span><?php echo $this->__('Continue Shopping') ?></span></span></button>
    </div>
</div>	

<?php else:?>

<div class="multiple-checkout">
	<div class="page-title">
    	<h1 class="order-success-title text-center" data-role="page-title"><?php echo $this->__('Order Success') ?></h1>
    </div>
    <h2 class="sub-title info-text-two mb-4"><?php echo $this->__('Thank you for your purchase!') ?></h2>
    <p class="para-normal"><?php echo $this->__('We are processing your order and you will soon receive an email with details of the order. Once the order has shipped you will receive another email with a link to track its progress.') ?></p>
    <?php if($_orderIds): ?>
    <p data-role="order-numbers" class="para-normal">
        <?php $flag = false ?>
        <?php echo $this->__('Your order number is ') ?>
        <?php foreach ($_orderIds as $orderId=>$incrementId): ?>
            <?php if ($flag): ?>
                <?php echo ', ' ?>
            <?php endif; ?>
            <?php $flag = true ?>
            <a class="para-bold text-uppercase" href="<?php echo $this->getViewOrderUrl($orderId) ?>"><?php echo $incrementId ?></a>
        <?php endforeach; ?>
    </p>
    <?php endif; ?>
    <?php echo $this->getChildHtml() ?>
    <div class="buttons-set text-center mt-4">
        <button type="button" title="<?php echo Mage::helper('core')->quoteEscape($this->__('Continue Shopping')) ?>" class="button dark-button next-button" onclick="setLocation('<?php echo $this->getContinueUrl() ?>')"><span><span><?php echo $this->__('Continue Shopping') ?></span></span></button>
    </div>
</div>

<?php endif;?>

<?php if(false):?>
<?php foreach ($_orderIds as $orderId=>$incrementId): ?>
<?php
    $order = Mage::getModel('sales/order')->load($orderId); 
    $order_id = $order->getIncrementId();   //the id of the order
    $gtotal = $order->getBaseGrandTotal();  //grand total of the order 
    $shippingVal = $order->getBaseShippingAmount();
    $taxAmount = $order->getBaseTaxAmount();
?>
<script type="text/javascript">
	ga('require', 'ecommerce');

    ga('ecommerce:addTransaction', {
      'id': '<?php echo $order_id; ?>',			// Transaction ID. Required.
      'affiliation': '',   						// Affiliation or store name.
      'revenue': '<?php echo $gtotal;?>',		// Grand Total.
      'shipping': '<?php echo $shippingVal;?>',	// Shipping.
      'tax': '<?php echo $taxAmount;?>'			// Tax.
    });

<?php $items = $order->getAllItems();?>
<?php foreach ($items as $itemId => $item):?>
    ga('ecommerce:addItem', {
      'id': '<?php echo $order_id; ?>',					// Transaction ID. Required.
      'name': '<?php echo $item->getName(); ?>',    	// Product name. Required.
      'sku': '<?php echo $item->getSku(); ?>',			// SKU/code.
      'category': '',									// Category or variation.
      'price': '<?php echo $item->getBasePrice(); ?>',	// Unit price.
      'quantity': '<?php echo $item->getQtyOrdered(); ?>' // Quantity.
    });
<?php endforeach;?> 

	ga('ecommerce:send');

</script>
<?php endforeach;?>
<?php endif;?>


<script type="text/javascript">
	window.dataLayer = window.dataLayer || [];
    <?php foreach ($_orderIds as $orderId=>$incrementId): ?>
    <?php
    $order = Mage::getModel('sales/order')->load($orderId); 
	    $incrementId = $order->getIncrementId();   //the id of the order
	    $gtotal = $order->getBaseGrandTotal();  //grand total of the order 
	    $shippingVal = $order->getBaseShippingAmount();
	    $taxAmount = $order->getBaseTaxAmount();
	    $orderItems = $order->getAllVisibleItems();
	    $intCtr = 0;
	    $itemscnt = count($orderItems);
	?>
    dataLayer.push({
        'transactionId': '<?php echo $incrementId?>',
        'transactionAffiliation': '',
        'transactionTotal': <?php echo $gtotal?>,
        'transactionTax': <?php echo $taxAmount?>,
        'transactionShipping': <?php echo $shippingVal?>,
        'transactionProducts': [
         <?php foreach($orderItems as $item): ?>
             <?php $intCtr++;?>
             <?php if($item->getParentItemId()) continue;?>
                {
                'sku': '<?php echo $item->getSku(); ?>',
                'name': '<?php echo $item->getName(); ?>',
                'category': '',
                'price': <?php echo $item->getBasePrice(); ?>,
                'quantity': <?php echo $item->getQtyOrdered(); ?>
              <?php if ($intCtr == $itemscnt):?>
                }]
              <?php else:?>
                },
              <?php endif;?>
          <?php endforeach;?>
    });
    <?php endforeach;?>
</script>


