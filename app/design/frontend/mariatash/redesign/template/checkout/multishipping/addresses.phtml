<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2006-2019 Magento, Inc. (http://www.magento.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * Ship to multiple address template
 *
 * @see Mage_Checkout_Block_Multishipping_Addresses
 * @var Mage_Checkout_Block_Multishipping_Addresses $this
 */
?>
<?php $redesignHelper = Mage::helper("redesign_checkout");?>
<?php $_productGiftWrap = $redesignHelper->getGiftWrap();?>
<?php $steps = Mage::getSingleton('checkout/type_multishipping_state')->getSteps();?>
<?php $cnt = 1;?>
<div class="container">
    <ol id="checkoutSteps" class="opc">
    <?php foreach ($steps as $stepKey => $_step): ?>
    	<?php if($stepKey == "multishipping_addresses"):?>
    	<li id="opc-<?= $stepKey?>" class="section allow active">
    		<div class="step-title checkout-step-name col-12">
                <span class="number"><?php echo $cnt ?></span>
                <h3><?php echo $this->__($_step->getLabel()) ?></h3>
            </div>
    		<?php echo $this->getMessagesBlock()->toHtml() ?>
            <form id="checkout_multishipping_form" action="<?php echo $this->getPostActionUrl() ?>" method="post">
                <div class="multiple-checkout">
                    <div class="page-title title-buttons">
                    	<div class="col2-set">
                        	<div class="gift-messages">
                            	<p class="control">
                                	<input type="checkbox" id="shipping-to-more-than-one" value="1" class="checkbox" checked="checked">
                                   	<label for="shipping-to-more-than-one"><span class="para-normal">Shipping to more than one address?</span></label>
                               	</p>
                           	</div>
                        </div>
                        <!-- <button data-action="add-new-customer-address" type="button" title="<//?php echo Mage::helper('core')->quoteEscape($this->__('Add New Address')) ?>" class="button light-button" onclick="$('add_new_address_flag').value=1; $('checkout_multishipping_form').submit();"><span><span><//?php echo $this->__('Add New Address') ?></span></span></button> -->
                    </div>
                    <input type="hidden" name="continue" value="0" id="can_continue_flag" />
                    <input type="hidden" name="new_address" value="0" id="add_new_address_flag" />
                    <div class="data-table col-12" id="multiship-addresses-table">
                        <div class="row">
    						<div class="">
                        	<?php foreach ($this->getItems() as $_index => $_item): ?>
                            <?php if ($_item->getQuoteItem()) :?>
                            <?php //if($_item->getQuoteItem()->getSku() == "GIFT_WRAP") continue;?>
    							<div class="col-12 product-description-section">
    								<div class="row">
                            			<div class="col-2">
                                    		<?php $_product = $_item->getQuoteItem()->getProduct() ?>
                                    		<?php
                                        		if ($option = $_item->getOptionByCode('simple_product')) {
                                        		    $_product = $option->getProduct();
                                        		}
                                		    ?>
                                			<p class="product-image">
                                     			<img src="<?= $this->helper('catalog/image')->init($_product, 'thumbnail')->resize(74,96); ?>" width="74" height="96" alt="<?php echo $this->escapeHtml($_product->getName()) ?>" title="<?php echo $this->escapeHtml($_product->getName()) ?>" />
                                 			</p>
                            			</div>
                                		<div class="col-6">
                                    		<?php echo $this->getItemHtml($_item->getQuoteItem())?>
                                    		<div class="item-options">
                                    			<input type="hidden" data-multiship-item-id="<?php echo $this->jsQuoteEscape($_item->getSku()) ?>" name="ship[<?php echo $_index ?>][<?php echo $_item->getQuoteItemId() ?>][qty]" value="<?php echo $this->escapeHtml($_item->getQty()) ?>" size="2" class="input-text qty" />
                                    		</div>
                                			<?php $message = Mage::helper('amstockstatus')->getStockMessage($_item);?>
    										<?php if(!empty($message)): ?>
                							<div class="box">
                                            	<div class="box-content">
                                                	<div class="item-msg">
                                                    	<p><span class="info-text-two">Availability:</span> <?php echo $message ?></p>
                                                    </div>
                                                </div>
                                             </div>
    										<?php endif;?>

                                            <div class="col2-set">
                                                <div class="gift-messages">
                                                 	<p class="control">
                                                   		<input type="checkbox" name="ship[<?= $_index ?>][<?= $_item->getQuoteItemId() ?>][is_gift_item]" id="gift_item_<?= $_index."_".$_item->getQuoteItemId()?>" value="1" class="checkbox" <?php if($_item->getIsGiftItem()):?>checked="checked" <?php endif;?>>
                                                        <label for="gift_item_<?= $_index."_".$_item->getQuoteItemId()?>"><span>This item is a gift (price will be hidden in the receipt).</span></label>
                                                   </p>
                                                </div>
                                                <div class="gift-messages">
                                                 	<p class="control">
                                                   		<input type="checkbox" name="ship[<?= $_index ?>][<?= $_item->getQuoteItemId() ?>][is_gift_wrap]" id="gift_wrap_item_<?= $_index."_".$_item->getQuoteItemId()?>" value="1" class="checkbox" <?php if($_item->getIsGiftWrap()):?>checked="checked" <?php endif;?>>
                                                        <label for="gift_wrap_item_<?= $_index."_".$_item->getQuoteItemId()?>"><span>Add gift wrap to this item (<?= ($_productGiftWrap) ? $this->helper('checkout')->formatPrice($_productGiftWrap->getPrice()) : '' ?>).</span></label>
                                                   </p>
                                                </div>
                                            </div>
                                		</div>
                                    	<div class="col-4 text-right multi-address-select-address-option">
                                    		<?php if ($_item->getProduct()->getIsVirtual()): echo $this->__('Shipping selection is not applicable.');else:echo $this->getAddressesHtmlSelect($_item, $_index);endif;?>
                                    	</div>
    								</div>
    							</div>
                            <?php endif; ?>
                        	<?php endforeach; ?>
    						</div>
    					</div>
                    </div>
                    <div class="billing-address billing-address-selection multi-address-select-address-option select col-12">
    					<div class="row">
    						<div class="col-12 p-0">
                    			<span class="info-text-two"><?= $this->__('Please select your billing address:')?></span>
    						</div>
                    		<?= $this->getChildHtml("checkout_address_select");?>
                    	</div>
    				</div>
                    <script type="text/javascript">decorateTable('multiship-addresses-table')</script>
                    <div class="buttons-set text-right">
                        <p class="back-link"><a href="<?php echo $this->getBackUrl() ?>"><small>&laquo; </small><?php echo $this->__('Back to Shopping Cart') ?></a></p>
                        <button type="submit" data-action="checkout-continue-shipping" title="<?php echo Mage::helper('core')->quoteEscape($this->__('Continue to Shipping Information')) ?>" class="light-button button next-button<?php if ($this->isContinueDisabled()):?> disabled<?php endif; ?>" onclick="$('can_continue_flag').value=1"<?php if ($this->isContinueDisabled()):?> disabled="disabled"<?php endif; ?>><span><span><?php echo $this->__('Next');//('Continue to Shipping Information') ?></span></span></button>
                    </div>
                </div>
                <?php echo $this->getBlockHtml("formkey") ?>
            </form>
            <div id="multiaddress-new-address" style="display: none;">
            	<?= $this->getChildHtml("customer_address_edit_form")?>
            </div>
    	</li>
    	<?php else:?>
    	<li id="opc-<?= $stepKey?>" class="section">
    		<div class="step-title checkout-step-name col-12">
                <span class="number"><?php echo $cnt ?></span>
                <h3><?= $_step->getLabel()?></h3>
            </div>
    	</li>
    	<?php endif;?>
    	<?php $cnt++; ?>
    <?php endforeach;?>
    </ol>
</div>
<script type="text/javascript">
    if (typeof Allure == "undefined") {
        var Allure = {};
    }
    Allure.baseUrl = '<?= $this->getBaseUrl() ?>';
</script>
<script type="text/javascript">
	jQuery(document).ready(function(){
		jQuery('.multi-address-select-address-option select').append('<option>New Address</option>');

		jQuery('.multi-address-select-address-option select').on('change',function(){
			newAddressForm(jQuery(this));
		});

		jQuery('#shipping-to-more-than-one').on('change',function(){
			if(! jQuery(this).is(":checked")){
				window.location.href = Allure.baseUrl+'checkout/onepage/';
			}
		});
	});

	function newAddressForm(evt){
		if(jQuery(evt)){
			jQuery(evt).val('');
		}

		if(!(jQuery(evt).val())){
			jQuery('#checkout_multishipping_form').hide();
			jQuery('#multiaddress-new-address').show();
		}else{
			jQuery('#checkout_multishipping_form').show();
			jQuery('#multiaddress-new-address').hide();
		}
	}
</script>
