<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     default_modern
 * @copyright   Copyright (c) 2011 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
$newsletterFormURL = preg_replace('|http(s)?\:\/\/|', '//', $this->getFormActionUrl());
?>

<img id="signup-exit" width="16px" src="<?php echo $this->getSkinUrl('images/redesign/thinner-cross.png'); ?>" alt="X" height="14px">


<script>
    let formFocus = false;
    jQuery('#signup-exit').on('click',function (e) {
        jQuery('.t_Tooltip.t_Tooltip_allure_footer').hide()
    });
    jQuery('.t_Tooltip.t_Tooltip_allure_footer').mouseleave(() => {
        if(!formFocus){
            jQuery('.t_Tooltip.t_Tooltip_allure_footer').hide();
        }
    });
    jQuery('#newsletter-validate-detail input').focus(e => {
        formFocus = true;
    });

    jQuery('#newsletter-validate-detail input').blur(e => {
        formFocus = false
    })
</script>
<div id="newsletter-form" >
    <form action="<?= $newsletterFormURL ?>" method="post" id="newsletter-validate-detail">
        <div class="form-subscribe-mt row">
            <div class="newsletter-mt">Newsletter</div>
            <div id="errors" class="validation-advice" style="display:none"></div>
            <!--<ul id="tld_r_ul">
                <li title="us">United States</li>
                <li title="mx">Mexico</li>
                <li title="jp">Japan</li>
                <li title="cn">Canada</li>
                <li title="sp">Spain</li>
            </ul>-->
            <div class="input-box col-12">
                <input type="text" autocomplete="off" name="email" id="email" class="input-text required-entry validate-email" placeholder="Email*" />
                <span id="msg-email" class="validation-advice maria-validation"></span>
            </div>
            <div class="input-box col-6">
                <input type="text" autocomplete="off" name="name" id="first_name" class="input-text required-entry" placeholder="First Name*"/>
                <span id="msg-name" class="validation-advice"></span>
            </div>
            <div class="input-box col-6">
                <input type="text" autocomplete="off" name="lastname" id="last_name" class="input-text required-entry" placeholder="Last Name*"/>
                <span id="msg-lastname" class="validation-advice"></span>
            </div>
            <?php
            $countryList = Mage::getModel('directory/country')->getResourceCollection()
                ->loadByStore()
                ->toOptionArray(true);
            ?>
            <div class="input-box col-12">
                <select class="input-text required-entry w-100" name="country_subscribe">
                    <?php foreach ($countryList as $country):
                        if($country['value']):
                            ?>
                            <option value="<?= $country['value'] ?>" <?= ($country['value']=="US")? "selected":""  ?>><?= $country['label'] ?></option>
                        <?php
                        endif;
                    endforeach; ?>
                    <option title="us">United States</option>
                </select>
            </div>
            <!--<div class="select-box col-12 input-box d-none">
                <input type="text" autocomplete="off" name="country_subscribe" id="country_subscribe" class="tld_static input-text required-entry" />
                <span id="msg-country" class="validation-advice"></span>
            </div>-->

            <div class="mt-terms-condtions-policy col-12">
                <label for="mt-newsl-terms"  class="custom-checkbox">
                    <input  type="checkbox" name="mt-newsl-terms"
                            id="mt-newsl-terms" value="1" class="checkbox">
                    <span class="checkmark"></span>
                    <p>
                        By clicking the sign up button, I agree to receive email marketing from Venus by Maria Tash, Inc. and have read the Venus by Maria Tash, Inc. <a class="link-button" href="/privacy-policy/">privacy policy</a> . You can unsubscribe at any time by clicking the link in our emails.
                    </p>
                </label>
            </div>


        </div>
        <div class="loader" style="display:none; width: 20px;">
            <img src="<?php echo Mage::getBaseUrl('media') . 'loading.gif' ?>" />
        </div>
        <button type="button" onclick="sendNewsletterSubscription(this.form)" title="<?php echo $this->__('Sign up') ?>" class="button dark-button">
            <?php echo $this->__('Sign Up') ?>
        </button>
    </form>
</div>
<div id="success"></div>
<script type="text/javascript">
    jQuery.noConflict();



    jQuery(document).ready(function() {
        jQuery('.t_Tooltip.t_visible').css('bottom' , '30px');
    });
    jQuery(window).resize(function() {
        jQuery('.t_Tooltip.t_visible').css('top' , '');
    });

    function sendNewsletterSubscription(form){

        jQuery('#msg-country').text('');
        jQuery('#msg-email').text('');
        jQuery('#msg-name').text('');
        jQuery('#msg-lastname').text('');

        var newsletterPrivacySelector = jQuery("#newsletter-validate-detail #mt-newsl-terms");
        var ischeck = newsletterPrivacySelector.prop('checked');
        if(ischeck == false){
            newsletterPrivacySelector.addClass("checkbox-error-validate");
            newsletterPrivacySelector.parent().addClass("label-error-validate");
            return;
        }else{
            newsletterPrivacySelector.removeClass("checkbox-error-validate");
            newsletterPrivacySelector.parent().removeClass("label-error-validate");
        }

        var newsletterSubscriberFormDetail = new VarienForm('newsletter-validate-detail');
        jQuery('.loader').css({display:'inline-block'});
        jQuery('.form-subscribe-mt .button').hide();
        jQuery('#success').hide();
        jQuery('#errors').hide();

        jQuery('#first_name').val(jQuery.trim(jQuery('#first_name').val()));
        jQuery('#last_name').val(jQuery.trim(jQuery('#last_name').val()));
        jQuery('#email').val(jQuery.trim(jQuery('#email').val()));
        var stringJSON='{"email":"'+jQuery('#email').val()+'","first_name":"'+jQuery('#first_name').val()+'","last_name":"'+jQuery('#last_name').val()+'","country":"Canada"}';
        var dataSend = JSON.parse(stringJSON);

        jQuery.getJSON(form.action,dataSend,function(data){
            jQuery('.loader').hide();
            jQuery('.form-subscribe-mt .button').show();
            if(data.success){
                jQuery('#newsletter-form').hide();
                jQuery('#success').show();
                jQuery('#success').html(data.thankyou);
                jQuery('.t_Tooltip.t_Tooltip_dark').css('height' , '120px');
                jQuery('.t_Shadow').css('height' , '120px');
                jQuery('.t_Skin').css('height' , '115px');
                jQuery('.t_Bubble').css('height' , '115px');
                jQuery('.t_ShadowBubble').css('height' , '115px');
                jQuery('.t_ShadowBubble canvas').css('height' , '120px');
                jQuery('.t_Tooltip.t_Tooltip_dark').css('bottom' , '30px');
                jQuery('.t_Tooltip.t_Tooltip_dark').css('background' , '#000');
                jQuery('.t_Tooltip.t_Tooltip_dark').css('top' , '');
                jQuery(window).resize(function() {
                    jQuery('.t_Tooltip.t_visible').css('top' , '');
                });
            }else{
                if(data.message.country){
                    jQuery('#msg-country').text(data.message.country);
                }
                if(data.message.email){
                    jQuery('#msg-email').text(data.message.email);
                }
                if(data.message.first){
                    jQuery('#msg-name').text(data.message.first);
                }
                if(data.message.last){
                    jQuery('#msg-lastname').text(data.message.last);
                }

                //jQuery('#errors').show();
                //jQuery('#errors').html(data.message);
            }
        });

    }

    jQuery( document ).ready(function() {

        /*CONVERT FIRSTNAME AND LASTNAME IN CAPITAL LETTERS*/
        jQuery('#first_name').keyup(function (evt) {
            convert(jQuery(this),'firstname',evt);
        });
        jQuery('#last_name').keyup(function (evt) {
            convert(jQuery(this),'lastname',evt);
        });

        if(jQuery('body').hasClass('mobile-device') && jQuery('.top-nav-3').length == 0) {
            let topNav = jQuery('.mobile-main_menu #top-nav').clone()
            jQuery(topNav).empty()
            jQuery(topNav).attr('id','top-nav-3')
            let footlinks = jQuery('#footer8 .footlinks')
            let footlinkLis = jQuery(footlinks).children().clone()
            let topNavLiLength = topNav.children().length

            jQuery(footlinkLis).each((i) => {
                let currentLi = footlinkLis[i]
                let firstElem = jQuery(currentLi).children().first()
                let dataId = jQuery(firstElem).attr('id')
                jQuery(currentLi).attr('data-id',`${dataId}-nav`)
                if(jQuery(currentLi).hasClass('data-block')) {
                    jQuery(currentLi).removeAttr('class');
                    jQuery(currentLi).addClass(`level0 nav-${i+(topNavLiLength+1)} level-top parent nav-item main_menu`);
                    let liName = jQuery(currentLi).find('.w-100 span')
                    let liContentMain = jQuery(currentLi).children().children().eq(1)
                    let liContent = jQuery(liContentMain).clone()
                    if(jQuery(currentLi).find('#newsletter-form').length) {
                        let inputBoxes = liContent.find('.input-box')
                        jQuery(liContent).css('margin-left','50px')
                        jQuery(inputBoxes).each((_i)=> {
                            let cInputBox = inputBoxes[_i]
                            jQuery(cInputBox).removeClass('col-6')
                            jQuery(cInputBox).removeClass('col-12')
                            jQuery(cInputBox).addClass('col-10')
                        })
                        jQuery(liContent).find('.mt-terms-condtions-policy').removeClass('col-12')
                        jQuery(liContent).find('.mt-terms-condtions-policy').addClass('col-10')

                    }else if(jQuery(currentLi).find('.customer-care-list').length) {
                        let listLis = jQuery(currentLi).find('.customer-care-list').children();
                        let html = ""
                        jQuery(listLis).each((_i) => {
                            let cLi = listLis[_i]
                            let span = jQuery(cLi).find('span').eq(1).html()
                            if(span === undefined) {
                                span = jQuery(cLi).find('span').eq(0).html()
                            }
                            let anchor = jQuery(cLi).find('a').attr('href')
                            html  += `<div class="col-lg col-12 piercing_options">
                                                <a href="${anchor}">
                                                    <div class="image-text text-center">
                                                        <h6 class="text-uppercase text-white">${span}</h6>
                                                     </div>
                                                </a>
                                            </div>`;
                        })
                        liContent = html
                    }
                    jQuery(currentLi).find('.w-100').remove();
                    jQuery(currentLi).append(`<a href="#" class="level-top"><span>${jQuery(liName[0]).html()}</span></a>`)
                    let lastSectionElement = jQuery('.mobile-sub_menu').children().last().clone();
                    jQuery(lastSectionElement).attr('id',`${dataId}-nav`)
                    jQuery(lastSectionElement).find('span').first().text(jQuery(liName[0]).html())
                    jQuery(lastSectionElement).find('.row.div-row').empty();
                    jQuery(liContent).show()
                    jQuery(liContent).attr('id','')
                    jQuery(lastSectionElement).find('.row.div-row').append(liContent)
                    //jQuery('#popup_ajax_contain').append(liContentMain)
                    jQuery('.mobile-sub_menu').append(lastSectionElement)
                }else {
                    jQuery(currentLi).removeAttr('class');
                    jQuery(currentLi).addClass(`level0 nav-${i+(topNavLiLength+1)} level-top noChild`);
                    let link = jQuery(currentLi).find('a')
                    jQuery(currentLi).append(link[0])
                    jQuery(currentLi).find('.w-100').remove();
                }
            })


            jQuery(topNav).append(footlinkLis)
            let socialIcons = jQuery('.social-media').clone();
            jQuery(topNav).append(socialIcons);
            jQuery('.mobile-main_menu').children().append(topNav)

            /*UPPEND FOOTER MENU*/
            jQuery('.mobile-main_menu .main_menu').click(function () {
                var section_id = jQuery(this).attr('data-id');
                console.log(section_id)
                jQuery('section.sub-menu').hide();
                jQuery('.mobile-sub_menu').find(`#${section_id}`).show();
            });

            jQuery('.close-section').click(function () {
                jQuery('section.sub-menu').hide();
            });
        }

        /*For mobile Menu only*/
        let form = jQuery('.menu-inner').find('#newsletter-validate-detail');
        if(form.length > 0) {
            form.attr('id', 'newsletter_validate_detail_menu');
            let inputElement = jQuery('.mt-terms-condtions-policy.col-10');
            let checkBox = inputElement.find('#mt-newsl-terms');
            let checkLabel = inputElement.find('.custom-checkbox');
            if (checkBox.length > 0) {
                checkBox.attr('id', 'mt_newsl_terms_menu')
                checkBox.attr('name', 'mt_newsl_terms_menu')
            }
            if (checkLabel.length) {
                checkLabel.attr('for', 'mt_newsl_terms_menu')
            }
            let $ = jQuery;
            $('#newsletter_validate_detail_menu').parent().attr('id','newsletter-form-menu')
            $('#newsletter-form-menu').find('.form-subscribe-mt').removeClass('form-subscribe-mt').addClass('form-subscribe-mt-menu');
            $('#newsletter-form-menu').find('#errors').attr('id','errors-menu');
            $('.menu-inner #success').attr('id','success-menu');
            $('.menu-inner #msg-country').attr('id','msg-country-menu');
            $('.menu-inner #msg-email').attr('id','msg-email-menu');
            $('.menu-inner #msg-name').attr('id','msg-name-menu');
            $('.menu-inner #msg-lastname').attr('id','msg-lastname-menu');
            $('.menu-inner #first_name').attr('id','first_name_menu');
            $('.menu-inner #last_name').attr('id','last_name_menu');
            $('.menu-inner #email').attr('id','email_menu');
            $('#newsletter_validate_detail_menu').find('.dark-button').addClass('subscribe-menu')
            $('.subscribe-menu').removeAttr('onclick');
            $('.subscribe-menu').unbind('click');
            $('.subscribe-menu').on('click',function () {
                sendNewsletterSubscriptionMenu(document.getElementById('newsletter_validate_detail_menu'))
            });
        }
        /*For Mobile menu Subscribe form*/
        function sendNewsletterSubscriptionMenu(form){

            jQuery('#msg-country-menu').text('');
            jQuery('#msg-email-menu').text('');
            jQuery('#msg-name-menu').text('');
            jQuery('#msg-lastname-menu').text('');

            var newsletterPrivacySelector = jQuery("#mt_newsl_terms_menu");
            var ischeck = newsletterPrivacySelector.prop('checked');
            if(ischeck == false){
                newsletterPrivacySelector.addClass("checkbox-error-validate");
                newsletterPrivacySelector.parent().addClass("label-error-validate");
                return;
            }else{
                newsletterPrivacySelector.removeClass("checkbox-error-validate");
                newsletterPrivacySelector.parent().removeClass("label-error-validate");
            }

            var newsletterSubscriberFormDetail = new VarienForm('newsletter-validate-detail-menu');
            jQuery('.loader').css({display:'inline-block'});
            jQuery('.form-subscribe-mt .button').hide();
            jQuery('#success-menu').hide();
            jQuery('#errors-menu').hide();

            jQuery('#first_name_menu').val(jQuery.trim(jQuery('#first_name_menu').val()));
            jQuery('#last_name_menu').val(jQuery.trim(jQuery('#last_name_menu').val()));
            jQuery('#email_menu').val(jQuery.trim(jQuery('#email_menu').val()));
            var stringJSON='{"email":"'+jQuery('#email_menu').val()+'","first_name":"'+jQuery('#first_name_menu').val()+'","last_name":"'+jQuery('#last_name_menu').val()+'","country":"Canada"}';
            var dataSend = JSON.parse(stringJSON);

            jQuery.getJSON(form.action,dataSend,function(data){
                jQuery('.loader').hide();
                jQuery('.form-subscribe-mt-menu .button').show();
                if(data.success){
                    jQuery('#newsletter-form-menu').hide();
                    jQuery('#success-menu').show();
                    jQuery('#success-menu').html(data.thankyou);
                    jQuery('.t_Tooltip.t_Tooltip_dark').css('height' , '120px');
                    jQuery('.t_Shadow').css('height' , '120px');
                    jQuery('.t_Skin').css('height' , '115px');
                    jQuery('.t_Bubble').css('height' , '115px');
                    jQuery('.t_ShadowBubble').css('height' , '115px');
                    jQuery('.t_ShadowBubble canvas').css('height' , '120px');
                    jQuery('.t_Tooltip.t_Tooltip_dark').css('bottom' , '30px');
                    jQuery('.t_Tooltip.t_Tooltip_dark').css('background' , '#000');
                    jQuery('.t_Tooltip.t_Tooltip_dark').css('top' , '');
                    jQuery(window).resize(function() {
                        jQuery('.t_Tooltip.t_visible').css('top' , '');
                    });
                }else{
                    if(data.message.country){
                        jQuery('#msg-country-menu').text(data.message.country);
                    }
                    if(data.message.email){
                        jQuery('#msg-email-menu').text(data.message.email);
                    }
                    if(data.message.first){
                        jQuery('#msg-name-menu').text(data.message.first);
                    }
                    if(data.message.last){
                        jQuery('#msg-lastname-menu').text(data.message.last);
                    }

                    //jQuery('#errors').show();
                    //jQuery('#errors').html(data.message);
                }
            });

        }


    });
</script>
