<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This soure file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     default_modern
 * @copyright   Copyright (c) 2011 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * Shopping cart template
 *
 * @see Mage_Checkout_Block_Cart
 */
?>
<?php
	$priceAlert = Mage::helper('shoppingcart')->dispatchPriceAlert();
?>
<script type="text/javascript" src="<?php echo Mage::getBaseUrl('js'); ?>jquery/jquery.cookie.js"></script>
<?php if ($priceAlert): ?>
        <div class="priceUpdate"><p><?php echo $this->__('The price of the items in your cart has been updated since you added them.'); ?></p></div>
    <?php endif; ?>
<div class="cart-mt">
    <h1>Shopping Cart</h1>

    <?php echo $this->getChildHtml('form_before') ?>
    <?php echo $this->getMessagesBlock()->getGroupedHtml() ?>
    
    <form id="shopping-cart-form" action="<?php echo $this->getUrl('checkout/cart/updatePost') ?>" method="post">
 	<?php //echo $this->getBlockHtml('formkey'); ?>
 	 <input type="hidden" name="form_key" value="<?php echo Mage::getSingleton('core/session')->getFormKey(); ?>" />
        <fieldset>
            <table id="shopping-cart-table" class="data-table cart-table" width="100%" border="0">
            	<colgroup><col width="1">
                	<col>
                    <col width="1">
                    <col width="1">
                    <col width="1">
                    <col width="1">
                    <col width="1">
				</colgroup>
                <thead class="shop-titles hidden-xs">
                <tr>
                    <th colspan="2"><?php echo $this->__('Product'); ?></th>
                    <th><?php echo $this->__('Price'); ?></th>
                    <th><?php echo $this->__('Qty '); ?></th>
                    <th><?php echo $this->__('Subtotal'); ?></th>
                    <th>&nbsp;</th>
                </tr>
                </thead>
                <tbody>
                    <?php $i = 0; $prices = array(); $skus = array(); ?>
                    <?php foreach ($this->getItems() as $_item): ?>
                        <?php echo $this->getItemHtml($_item) ?>
                        <?php
                            $prices[$i] = floatval($_item->getPrice());
                            $skus[$i] = $_item->getSku();
                            $i++
                        ?>
                    <?php endforeach ?>
                </tbody>
            </table>
        </fieldset>
    </form>

    <div class="cart-collaterals">
        <div class="collat-wrap">
            <div class="coupons-mt">
                <div class="totals">
                    <?php // if (!$this->getIsVirtual()): echo $this->getChildHtml('shipping'); endif; ?>
                    <?php echo $this->getChildHtml('totals'); ?>
                    <?php if (!$this->hasError()): ?>
                    <?php endif; ?>
                </div>
                <div class="coupons"><?php echo$this->getChildHtml('giftcards'). "</br>" .  $this->getChildHtml('coupon')  ?></div>
            </div>
            <div class="cart_cms_block" style="display:none">
                <?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('shoppingcart_links')->toHtml(); ?>
            </div> 
            <div class="crosssell-wrap">
                <?php echo $this->getChildHtml('crosssell') ?>
            </div>
            <div>
                <div class="pay-caart">
                    <button type="button" title="Continue Shopping" class="button cart-continue-mt"
                            onclick="setLocation('<?php echo $this->getContinueShoppingUrl(); ?>')">
                        <span><span>Continue Shopping</span></span>
                    </button>
                    <ul class="checkout-types">
                        <?php foreach ($this->getMethods('methods') as $method): ?>
                            <?php if ($methodHtml = $this->getMethodHtml($method)): ?>
                                <li><?php echo $methodHtml; ?></li>
                            <?php endif; ?>
                        <?php endforeach; ?>
                    </ul>
                </div>
            </div>

            <?php if ($this->getContinueShoppingUrl()): ?>
            <?php endif; ?>
        </div>

    </div>

</div>
<script>
    function plusMinus(elementId,plus){
        /* jQuery.fancybox.showLoading();
        jQuery.fancybox.helpers.overlay.open({parent: $('body'),closeClick : false});
        if(parseInt(jQuery(elementId).val()) + plus > 0) {
            jQuery(elementId).val(parseInt(jQuery(elementId).val()) + plus);
        }
        jQuery( "#shopping-cart-form" ).submit(); */



        var qty = parseInt(jQuery(elementId).val()) + plus ;
        if(qty > 0) {
            var parent = jQuery(elementId).parent().parent().parent();
            jQuery(elementId).val(qty);
            var item_id = jQuery(elementId).attr('data-item-id');
            var price = jQuery(elementId).attr('data-price');
            var qtyData = {qty:qty};
            var cart={};
            cart[item_id] = qtyData;
            cart = JSON.stringify(cart);
            var form_key = jQuery('#mt-cart-tab #shopping-cart-form input[name="form_key"]').val();
            showLoadingFancybox();
            jQuery.ajax({
		        url: '<?php echo Mage::getBaseUrl('web').'checkout/cart/updateQtyAjax';?>',
		        dataType : 'json',
				type : 'POST',
				data: {'cart':cart,'price':price,'qty':qty,'form_key':form_key},
		        success: function(data) {
		        	if(data.success){
			        	jQuery('.glyphicon-shopping-cart').attr('counter',data.top_qty);
		        		jQuery('#mt-cart-tab .collateral-box').html("");
			        	jQuery('#mt-cart-tab .collateral-box').html(data.html);
		        	}
		        	hideLoadingFancybox();
		        }
		    });
        }
        
    }


    function removeCartItem(item_id){
//    	if(confirm("Are you sure you want to delete this?")){
			//var item_id = jQuery(event).attr('data-item-id');
			var form_key = jQuery('#mt-cart-tab #shopping-cart-form input[name="form_key"]').val();
				showLoadingFancybox();
				itemXhr =	jQuery.ajax({
			        url: '<?php echo Mage::getBaseUrl('web').'checkout/cart/removeItemAjax';?>',
			        dataType : 'json',
					type : 'POST',
					data: {'id':item_id,'form_key':form_key},
			        success: function(data) {
			        	if(data.success){
			        		jQuery('.glyphicon-shopping-cart').attr('counter',data.top_qty);
			        		jQuery('#mt-cart-tab .collateral-box').html("");
				        	jQuery('#mt-cart-tab .collateral-box').html(data.html);
			        	}
			        	hideLoadingFancybox();
			        }
			    });
		/*}else{
			return false;
		}*/
    }

    function addItemToWishlist(event){
    	var item_id = jQuery(event).attr('data-item-id');
		showLoadingFancybox();
		jQuery.ajax({
		      url: '<?php echo Mage::getBaseUrl("web").'wishlist/index/fromcartAjax' ?>',
		      dataType : 'json',
			  type : 'POST',
			  data: {'item':item_id},
		      success: function(data) {
		          if(data.success){
		        	  jQuery('#mt-wishlist-tab .collateral-box .my-wishlist').html("");
		        	  jQuery('#mt-wishlist-tab .collateral-box .my-wishlist').html(data.html);
			          
		        	  jQuery('.glyphicon-shopping-cart').attr('counter',data.top_qty);
		        	  jQuery('#mt-cart-tab .collateral-box').html("");
			          jQuery('#mt-cart-tab .collateral-box').html(data.cart_html);
		          }else{
			          alert(data.message);
		          }
		          hideLoadingFancybox();
		     }
		 });
    }
    

    
    jQuery( ".qty-wrap input" ).focusout(function() {
        if(this.next().value != this.value) {
            jQuery.fancybox.showLoading();
            jQuery.fancybox.helpers.overlay.open({parent: $('body'),closeClick : false});
            jQuery( "#shopping-cart-form" ).submit();
        }
    })
    jQuery(document).bind("keydown", function(e) {
        var code = e.keyCode || e.which;
        if (code  == 13) {
            e.preventDefault();
            return false;
        }
    });
</script>
<script>
	jQuery(window).load(function(){
	  setTimeout(function(){ jQuery('ul.messages').fadeOut() }, 3000);
	});
    jQuery('a.scl-popup').fancybox({
        openEffect  : 'none',
        closeEffect : 'none',
        nextEffect  : 'none',
        prevEffect  : 'none',
        padding     : 0,
        mouseWheel : false,
        loop            : false,
        helpers : {
            title : null
        },
        width: 785,
        minWidth: 785,
        maxWidth: 785,
        height: 572,
        minHeight: 572,
        maxHeight: 572
    });

</script>
