<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>

<?php if($this->isDeleiveryMethodTwoShipment() && $this->isWholeSaleCustomer()):?>
<div id="wholeseller-payment-methods">
	<ul class="form-list">
		<li class="control pay_now_li" onclick="switchPayOptions(this);" name="mt-pay-now">
			<input  class="radio pay_now" id="payment-pay-now" value="pay_now" type="radio" name="payment[wholesale_pay_option]" checked="checked" />
			<label>Pay Now (recommended)</label>
		</li>
		<?php if($this->isContainsOutofStockProducts()):?>
			<li class="control" onclick="switchPayOptions(this);" name="mt-pay-as-ship">
				<input  class="radio pay_as_ship" id="payment-pay-credit-card" value="pay_as_ship" type="radio" name="payment[wholesale_pay_option]" />
				<label>Pay as you ship (credit card required)</label>
			</li>
		<?php endif;?>
	</ul>
</div>
<?php endif;?>


<div id="reload_payment">
<dl class="sp-methods" id="checkout-payment-method-load">
<?php
    $methods = $this->getMethods();
    $oneMethod = count($methods) <= 1;
?>

<?php
	//Allure mt added code.
	$payNowArr = $this->getPayNowOptionsMenthods();
	$payAsShipArr = $this->getPayAsShipOptionsMethods();
?>

<?php
    foreach ($methods as $_method):
        $_code = $_method->getCode();
?>
    <dt class="<?php echo (in_array($_code,$payNowArr)?"mt-pay-now":""); 
    	echo (in_array($_code,$payAsShipArr)?" mt-pay-as-ship":"");?>"
    	style="display:<?php echo (in_array($_code,$payNowArr)?"block":"none");?>">
    <?php if(!$oneMethod): ?>
        <input id="p_method_<?php echo $_code ?>" value="<?php echo $_code ?>" type="radio" name="payment[method]" title="<?php echo $this->htmlEscape($_method->getTitle()) ?>" onclick="payment.switchMethod('<?php echo $_code ?>')"<?php if($this->getSelectedMethodCode()==$_code): ?> checked="checked"<?php endif; ?> class="radio" />
    <?php else: ?>
        <span class="no-display"><input id="p_method_<?php echo $_code ?>" value="<?php echo $_code ?>" type="radio" name="payment[method]" checked="checked" class="radio" /></span>
        <?php $oneMethod = $_code; ?>
    <?php endif; ?>
        <label id="label-<?php echo $_code;?>" <?php if($this->getSelectedMethodCode()==$_code): ?> class="radio payment-checked"<?php endif; ?> for="p_method_<?php echo $_code ?>"><?php echo $this->escapeHtml($this->getMethodTitle($_method)) ?> <?php echo $this->getMethodLabelAfterHtml($_method) ?></label>
    </dt>
   	<?php if ($_code == 'authnetapplepay') :?>
    <dd><ul class="form-list" id="payment_form_authnetapplepay" style="display:none;">
            <li class="form-alt">Pay with Apple Pay from your Phone
                	<script type="text/javascript">
                		//<![CDATA[
                		<?php /** We have to load our scripts dynamically as such, because opc will not load them otherwise. Injecting via layout would only cause compatibility problems. **/ ?>
                		if ( typeof AllureApplePay == 'undefined' ) {
                			var AllureApplePay = {};
                
                			AllureApplePay.BaseUrl = '<?php echo Mage::getUrl('applepay/process'); ?>';
                			AllureApplePay.MerchantId = '<?php $_method->getConfigData('merchant_id') ?>';
                			AllureApplePay.MerchantName = '<?php $_method->getConfigData('merchant_name') ?>';
                			
                			var s = document.createElement('script');
                			s.type = "text/javascript";
                			s.src = "<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_JS) . 'allure/authnetapplepay.js'; ?>";
                			var fs = document.getElementsByTagName('script')[1];
                			fs.parentNode.insertBefore(s, fs);
                
                			AllureApplePay.Initialised = true;
                		}
                    	//]]>
            		</script>
                <script type="text/javascript">
                		//<![CDATA[
                    	//]]>
                	</script>
            	</li>
 		</ul>
    </dd>
    <?php else:?>
    <?php if ($html = $this->getPaymentMethodFormHtml($_method)): ?>
    <dd>
        <?php echo $html; ?>
    </dd>
    <?php endif; ?>
    <?php endif;?>
<?php endforeach; ?>
</dl>
</div>
<?php echo $this->getChildChildHtml('additional'); ?>
<script type="text/javascript">
//<![CDATA[
<?php echo $this->getChildChildHtml('scripts'); ?>
//payment.init();
payment.singleMethod = true;
<?php if (is_string($oneMethod)): ?>
    payment.switchMethod('<?php echo $oneMethod ?>');
    payment.singleMethod = '<?php echo $oneMethod ?>';
<?php endif; ?>
    if($('promoCode')){
        $('promoCode').removeAttribute('disabled');
    }
    jQuery('dl.sp-methods > div.promoDiv').remove();
   <?php if($codeExists): ?>
       $('promoCode').disable();
   <?php endif; ?>
    function couponApply(remove){
        if($F('promoCode') == '') {
            $('advice-required-entry-promoCode_code').innerHTML = 'This is a required field';
            $('advice-required-entry-promoCode_code').show();
            return false;
        }
        else $('advice-required-entry-promoCode_code').hide();
        var params = {
                coupon_code: $F('promoCode'),
                ajax: 1,
                remove: remove
         };
        new Ajax.Request('<?php echo $this->getUrl('checkout/cart/couponPost', array('_secure'=>true)) ?>', {
            method:'post',
            parameters: params,
            onSuccess: function(transport) {
              var data = transport.responseText.evalJSON();
              if(data.error){
                  $('advice-required-entry-promoCode_code').innerHTML = data.message;
                  $('advice-required-entry-promoCode_code').removeClassName('applied');
                  $('advice-required-entry-promoCode_code').addClassName('false');
                  $('advice-required-entry-promoCode_code').show();
                    return false;
              } else if(data.disable) {
                  $('promoCode').disable();
                  $('promoCodeLinkAdd').hide();
                  $('promoCodeLinkRemove').show();
                  $('advice-required-entry-promoCode_code').innerHTML = 'Promo Code was applied';
                  $('advice-required-entry-promoCode_code').addClassName('applied');
                  $('advice-required-entry-promoCode_code').removeClassName('false');
                  $('advice-required-entry-promoCode_code').show();
              } else{
                 $('promoCode').enable(); 
                 $('promoCodeLinkAdd').show();
                 $('promoCode').value = '';
                 $('promoCodeLinkRemove').hide();
              }              
              $('totalsDivRightNav').innerHTML = '<div class="loading-div">Loading</div>';
              $('reload_payment').innerHTML = '<div class="loading-div">Loading</div>';
              new Ajax.Updater('reload_payment','<?php echo $this->getUrl('checkout/onepage/reloadpayment') ?>',{method: 'post',
                onComplete: function() {
                    if(data.error){
                          $('advice-required-entry-promoCode_code').innerHTML = data.message;
                          $('advice-required-entry-promoCode_code').removeClassName('applied');
                          $('advice-required-entry-promoCode_code').addClassName('false');
                          $('advice-required-entry-promoCode_code').show();
                            return false;
                      } else if(data.disable) {
                          $('promoCode').disable();
                          $('promoCodeLinkAdd').hide();
                          $('promoCodeLinkRemove').show();
                          $('advice-required-entry-promoCode_code').innerHTML = 'Promo Code was applied';
                          $('advice-required-entry-promoCode_code').addClassName('applied');
                          $('advice-required-entry-promoCode_code').removeClassName('false');
                          $('advice-required-entry-promoCode_code').show();
                      } else{
                         $('promoCode').enable(); 
                         $('promoCodeLinkAdd').show();
                         $('promoCode').value = '';
                         $('promoCodeLinkRemove').hide();

                         if (payment && payment.singleMethod) {
                     		payment.switchMethod(payment.singleMethod);
                     	 }
                      }
                }
              });
              new Ajax.Updater('totalsDivRightNav', '<?php echo $this->getUrl('checkout/cart/refreshtotals', array('_secure'=>true)) ?>', { method: 'get' });
            },
            onFailure: function() { 
                alert('Error applying coupon code!');
            }
          });
    };
     
    function giftCardApply(url,applied){
        if($F('giftcard_code') == '' && applied) {
            $('advice-required-entry-giftcard_code').innerHTML = 'This is a required field';
            $('advice-required-entry-giftcard_code').show();
            return false;
        }
        else $('advice-required-entry-giftcard_code').hide();
        var params = {
                giftcard_use: $('giftcard_use').checked ? '1':'0',
                giftcard_code: $F('giftcard_code'),
                ajax: 1
         };
        new Ajax.Request(url, {
            method:'post',
            parameters: params,
            onSuccess: function(transport) {
                var data = transport.responseText.evalJSON();               
                if(data.error){
                    if(data.message) {
                        $('advice-required-entry-giftcard_code').innerHTML = data.message;
                        $('advice-required-entry-giftcard_code').removeClassName('applied');
                        $('advice-required-entry-giftcard_code').addClassName('false');
                        $('advice-required-entry-giftcard_code').show();
                    }
                    return false;
                } else if (data.active) {
                    //$('current_balance').innerHTML = 'You Have ' + data.current_balance + ' on This Card';
                    //$('current_balance').show();
                    if(data.message) {
                        $('advice-required-entry-giftcard_code').innerHTML = data.message;
                        $('advice-required-entry-giftcard_code').removeClassName('false');
                        $('advice-required-entry-giftcard_code').addClassName('applied');
                        $('advice-required-entry-giftcard_code').show();
                    }
                    $('giftcard_code').addClassName('required-entry');
                    $('giftcard_use').checked = 1;
                    $('giftcard_use').value = "1";
                    $('giftcard_code').value = '';
                } else {
                    if(data.message) {
                        $('advice-required-entry-giftcard_code').innerHTML = data.message;
                        $('advice-required-entry-giftcard_code').removeClassName('false');
                        $('advice-required-entry-giftcard_code').addClassName('applied');
                        $('advice-required-entry-giftcard_code').show();
                    }
                    $('advice-required-entry-giftcard_code').hide();
                    $('giftcard_code').removeClassName('required-entry');
                    $('giftcard_use').checked = 0;
                    $('giftcard_use').value = "0";
                }
                $('totalsDivRightNav').innerHTML = '<div class="loading-div">Loading</div>';
                $('reload_payment').innerHTML = '<div class="loading-div">Loading</div>';
                $('gift_amount').innerHTML = '<?php echo Mage::app()->getLocale()->currency(Mage::app()->getStore()->getCurrentCurrencyCode())->getSymbol(); ?>' + data.current_balance;
                new Ajax.Updater('reload_payment','<?php echo $this->getUrl('checkout/onepage/reloadpayment') ?>',{method: 'post', 
                    onComplete: function () {
                        if (jQuery.browser.msie && jQuery.browser.version == "8.0" && typeof checkout !== 'undefined') {
                            if (jQuery('#giftcard_use').attr('checked')) {
                                jQuery('#giftcard_use').next().css('background', 'url(' + checkout.skinUrl + 'frontend/mt/default/images/checkbox-login.png) no-repeat 0 -20px');
                            } else {
                                jQuery('#giftcard_use').next().css('background', 'url(' + checkout.skinUrl + 'frontend/mt/default/images/checkbox-login.png) no-repeat 0 0');
                            }
                            var bgChecked =  checkout.skinUrl + 'frontend/mt/default/images/radio-button-checked.png';
                            jQuery('#checkout-payment-method-load dt input').each(function () {
                                if (jQuery(this).attr('checked'))
                                    jQuery(this).next().css('background', 'url(' + bgChecked + ') no-repeat left');
                                jQuery(this).bind('change', function() {
                                    jQuery('#checkout-payment-method-load dt label').attr('style', '');
                                    if (jQuery(this).attr('checked')) {
                                        jQuery(this).next().css('background', 'url(' + bgChecked + ') no-repeat left');
                                    }
                                });
                            });
                        }
                    }
                });
                new Ajax.Updater('totalsDivRightNav', '<?php echo $this->getUrl('checkout/cart/refreshtotals', array('_secure'=>true)) ?>', { method: 'get' });
            },
            onFailure: function() { 
                alert('Error applying gift card code!'); 
            }
          });
    };   
    function uncheckPayment(){
     jQuery('input[name="payment[method]"]').each(function () {  
              var payment = jQuery(this).val();      
              if(payment){
                jQuery('#label-'+payment).attr('class','');
              }
        }); 
    }
    jQuery(document).ready(function(){
    	if($('totalsDivRightNav')!=null)
        	$('totalsDivRightNav').innerHTML = '<div class="loading-div">Loading</div>';
        $('reload_payment').innerHTML = '<div class="loading-div">Loading</div>';
        new Ajax.Updater('totalsDivRightNav', '<?php echo $this->getUrl('checkout/cart/refreshtotals', array('_secure'=>true)) ?>', { method: 'get' ,
            onComplete: function(transport) {
                jQuery("#country").selectBoxIt({
                        aggressiveChange: true
                }).data("selectBoxIt");               
                // Fix payment check box for ie
                jQuery('input[name="payment[method]"]').each(function () {                      
                      var payment = jQuery(this).val(); 
                      if(payment){
                        if(jQuery(this).is(':checked')){                        
                           jQuery(this).attr('class','radio payment-checked');
                           if(payment == 'authorizenet'){
                               jQuery('#payment_form_'+payment).show();
                           }
                        }
                        jQuery('#label-'+payment).click(function(){                         
                            uncheckPayment();
                            jQuery(this).attr('class','radio payment-checked');
                        });
                      }
                      
                }); 
            }
        });
        jQuery("#co-payment-form select").selectBoxIt({aggressiveChange: true});
        setTimeout(function() { new Ajax.Updater('reload_payment', '<?php echo $this->getUrl('checkout/onepage/reloadPayment') ?>',{
            onComplete: function(transport) {
                // Fix payment check box for ie
                jQuery('input[name="payment[method]"]').each(function () {
                    var payment = jQuery(this).val();
                    if(payment){
                        if(jQuery(this).is(':checked')){
                            jQuery(this).attr('class','radio payment-checked');
                            if(payment == 'authorizenet'){
                            }
                        }
                        jQuery('#label-'+payment).click(function(){
                            uncheckPayment();
                            jQuery(this).attr('class','radio payment-checked');
                        });
                    }

                });
                
                if (payment && payment.singleMethod) {
            		payment.switchMethod(payment.singleMethod);
            	}
            }
        }); },1000);

    });
    
//]]>
</script>

