<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     default_modern
 * @copyright   Copyright (c) 2011 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * Product list template
 *
 * @see Mage_Catalog_Block_Product_List
 */
?>
<?php
$_productCollection = $this->getLoadedProductCollection();
$_helper = $this->helper('catalog/output');
$mediaUrl = Mage::getBaseUrl('media');
$_test = $this->getRequest()->getParam('test');
$mode  = $this->getMode();
?>
<script type="text/javascript">
    var BASE_URL = '<?php echo Mage::getBaseUrl('web'); ?>';
    function productItemSwatchBinding(listSelector) {
        jQuery(listSelector + ' .item').each(function() {           
            var product_id = parseInt(jQuery(this).attr('id').replace('item-', ''));            
            var superAtt  = 'super-attribute-' + product_id;
            var quickview = 'product-quickview-' + product_id;  
            var listIds   = jQuery('#list-'+product_id).text();
            // Check configurable
            //if(!listIds) return false;
            if(!listIds) listIds = product_id;
            
            if (jQuery('#list-img-'+product_id).text()=='1')
                return false;

            jQuery.ajax({
                type: "POST",    
                dataType : "json",
                url: BASE_URL + "ecpcolor/",
                data: {options: listIds,mode:'<?php echo $mode;?>', location: "Boston"}
            }).done(function(response) {
                if (response.colors != '') {                  
                   jQuery("#color-icons-"+product_id).html(response.colors);
                   jQuery('#list-img-'+product_id).text('1') ;
     
                   jQuery('#color-icons-' + product_id + ' li').each(function(){
                        var color_id  = jQuery(this).attr('id'),  
                            color_title = jQuery(this).attr('title'); 
                        Tipped.create(jQuery("#" + color_id), color_title, {
                                skin: 'customTiny',
                                showOn: ['click', 'mouseover'],
                                background: { color: '#fff', opacity: .7 }
                        });

                        jQuery(this).click(function(){
                            var product_id = jQuery(this).parent().data('product_id');
                            var swatch_id = jQuery(this).attr('id');
                            console.log('PRODUCT#'+product_id);
                            console.log('SWATCH#'+swatch_id);
                            var option = jQuery(this).attr('value'); 
                            removeActive(product_id);
                            jQuery(this).addClass('active');
                            var imgSrc = jQuery('#img-'+ swatch_id).text();   
                            var price  = jQuery('#price-'+ swatch_id).html();
                            var pv = jQuery('#link-pv-'+product_id).text() + '?optionId=' +option;
                            var qv = jQuery('#link-qv-'+product_id).text() + '?optionId=' +option;  
                            if(price){
                                jQuery("#default-price-"+product_id).html(price);
                            }
                            console.log('#img-'+ product_id);
                            console.log('src='+ imgSrc);
                            if(imgSrc) {                                
                                jQuery('#img-'+ product_id).attr('src',imgSrc);
                                jQuery('a#' + product_id).attr('href',pv);
                                jQuery('#product-quickview-'+ product_id).attr('href',qv)
                            }
                            jQuery('.price-box').show();
                        });
                    });
                }   

                if (response.price != '') {     
                    jQuery("#default-price-"+product_id).html(response.price);
                    jQuery("#default-price-"+product_id+" .price-box").show();
                }      
                
            });
        })
        function removeActive(product_id){
            jQuery('#color-icons-' + product_id + ' li').each(function(){
               jQuery(this).removeClass('active') ;
            });
        }
    }
</script>
<?php $price = $this->getRequest()->getParam('price');?>
<?php if (!$_productCollection->count() || ($price == '0,0')): ?>
    <div class="category-products">
    <div id="productsContainer-wrapper">
        <p class="note-msg"><?php echo $this->__('There are no products matching the selection.') ?></p>
    </div>
    </div>
<?php else: ?>
    <div class="category-products">
        <div class="toolbar-top">
            <?php echo $this->getToolbarHtml() ?>
        </div>
        <div id="loaderProducts" class="hideLoader"><img src="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_SKIN) . '/frontend/mt/default/images/loading.gif' ?>"></div>
        <div id="productsContainer-wrapper">
            <div id="productsContainer">
                <?php // List mode ?>
                <?php if ($this->getMode() != 'grid'): ?>
                    <?php // Grid Mode ?>

                    <?php $_collectionSize = $_productCollection->count() ?>
                    <?php $_columnCount = $this->getColumnCount(); ?>
                    <?php $_iterator = 0; ?>
                    <ul class="products-grid2"  style="text-align:left;">
                        <?php $i = 0;
                        foreach ($_productCollection as $_product): ?>
                            <?php
                            $quickViewUrl = $this->getUrl('quickview/index/index', array('id' => $_product->getId()));
                            $productUrl = $_product->getProductUrl();
                            $currentProductId = $_product->getId();
                            $simples = $this->getIcons($currentProductId);                           
                            ?>
                            <li class="item" id="item-<?php echo $_product->getId() ?>">
                                <a id="<?php echo $_product->getId() ?>"
                                   href="<?php echo $productUrl; ?>"
                                   class="product-image"><img id="img-<?php echo $_product->getId() ?>" class="productimg"
                                                           src="<?php echo $this->helper('catalog/image')->init($_product, 'small_image')->resize(314, 409); ?>"
                                                           width="314" height="409"
                                                           alt="<?php echo $this->stripTags($this->getImageLabel($_product, 'image'), null, true) ?>"/></a>
                                <div class="grid-mt-w">
                                    <h2 id="<?php echo $_product->getId() ?>" class="product-name">
                                        <a  id="product-name-<?php echo $_product->getId() ?>" href="<?php echo $productUrl; ?>"
                                            title="<?php echo $this->stripTags($_product->getName(), null, true) ?>"><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?></a>
                                    </h2>
                                    <div class="priceCategory" id="default-price-<?php echo $_product->getEntityId(); ?>"><p><?= $this->getPriceHtml($_product) ?></p></div>
                                    <div style="display:none;">
                                        <span id="link-qv-<?php echo $_product->getId(); ?>"><?php echo $quickViewUrl; ?></span>
                                        <span id="link-pv-<?php echo $_product->getId(); ?>"><?php echo $productUrl; ?></span>
                                    </div>
                                    <div class="actions swatches">
                                        <?php if ($_product->getTypeId() == 'configurable'): ?>
                                        <img id="loading-<?php echo $_product->getId() ?>" style="display:none;" src="<?php echo $mediaUrl . 'loading.gif'; ?>"/>
                                        <div class="super_attribute" id="super-attribute-<?php echo $_product->getId() ?>">                                                    
                                            <?php 
                                            $productId = $_product->getId();
                                            $optionsValues = $this->getIcons($productId);  
                                            if(!empty($optionsValues)):
                                                $attribute_code = $optionsValues['code'];
                                                $attribute_label = $optionsValues['label'];  
                                                ?>
                                                <div id="list-<?php echo $productId;?>" style="display: none;"><?php echo json_encode($optionsValues);?></div>
                                                <div id="list-img-<?php echo $productId;?>" style="display:none">0</div>
                                                <div id="color-option" class="color-icon">
                                                    <span>
                                                        <?php echo $attribute_label; ?>: 
                                                    </span>
                                                </div>    
                                                <ul id="color-icons-<?php echo $productId;?>" data-product_id="<?php echo $productId;?>">
                                                    <?php 
                                                    $j=0;
                                                    $i=0;
                                                    $firstOption = '';
                                                    foreach ($optionsValues['value'] as $option): ?>  
                                                    <?php                                                            
                                                        $optionId = $option[$attribute_code];
                                                        $optionLb = $option[$attribute_code . "_value"];
                                                        $simple_id = $option['child_id'];  
                                                        if($j==0) $firstOption = $optionId;
                                                        $j++;
                                                        ?>
                                                        <li data-id="<?php echo $simple_id ?>"
                                                           	id="color-icon-<?php echo $simple_id ?>" 
                                                           	style="background: url('<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA) . 'amconf/images/' . $optionId . '.jpg'; ?>');width: 21px; height: 22px;" 
                                                            class="colorSelector tipped-create <?php echo ($i==0)?" active":""; $i++;?>" value="<?php echo $optionId ?>" 
                                                            title="<?php echo $optionLb ?>" >
                                                            <div style="display: none">
                                                                  <span id="img-<?php echo $simple_id; ?>"></span>
                                                                  <span id="price-<?php echo $simple_id; ?>"></span>
                                                            </div>
                                                        </li>            
                                                    <?php endforeach; ?>
                                                </ul>                                                  
                                                <?php endif;?> 
                                            </div>                                            
                                        <?php endif;?>
                                    </div>
                                    <div class="actions">                 
                                        <?php 
                                               $check = true;
                                               if($_test == 1)
                                                $check = $_product->getIsSalable();
                                               else 
                                                $check = $_product->getIsSalable2();
                                         ?>
                                        <?php if ($check): ?>
                                            
                                                <?php if ($this->helper('wishlist')->isAllow()) : ?>
                                                    <a href="<?php echo $this->helper('wishlist')->getAddUrl($_product); ?>" class="link-wishlist glyphicon glyphicon-star">
                                                        <span><?php echo $this->__('Add to Wishlist') ?></span>
                                                    </a>
                                                <?php endif; ?>

                                                <a class="button"
                                                   id='product-quickview-<?php echo $_product->getId() ?>'
                                                   href="<?php echo $_product->getProductUrl(); ?>"
                                                   title="<?php echo $this->__('Add to Cart') ?>"><span><?php echo $this->__('Add to Cart') ?></span><span class="glyphicon glyphicon-shopping-cart"></span></a>
                                                <!-- <a class="fancybox fancybox.iframe button btn-quickview"
                                                   id='product-quickview-<?php echo $_product->getId() ?>'
                                                   href="<?php echo $quickViewUrl; ?><?php if($firstOption) echo "?optionId=$firstOption";?>"
                                                   title="<?php echo $this->__('quick view') ?>"><span><?php echo $this->__('quick view') ?></span></a> -->
                                        <?php else: ?>
                                            <p class="availability out-of-stock"><span><?php echo $this->__('Out of stock') ?></span></p>
                                        <?php endif; ?>
                                    </div>
                                </div>
                            </li>
        				<?php endforeach ?>
                    </ul>
                    <script type="text/javascript">
                        jQuery(document).ready(function(){
                            //productItemSwatchBinding('ul.products-grid2');
                        });
                        decorateGeneric($$('ul.products-grid2'), ['odd', 'even', 'first', 'last']);
                    </script>
                <?php else: ?>

                    <?php // Grid Mode     ?>

                    <?php $_collectionSize = $_productCollection->count() ?>
                    <?php $_columnCount = $this->getColumnCount(); ?>
                        <?php $_iterator = 0; ?>
                    <ul class="products-grid" style="text-align:left;">
                        <?php
                        $i = 0;
                        foreach ($_productCollection as $_product):
                            ?>
                            <?php
                            $quickViewUrl = $this->getUrl('quickview/index/index', array('id' => $_product->getId()));
                            $productUrl = $_product->getProductUrl();
                            $currentProductId = $_product->getId();
                            $simples = $this->getIcons($currentProductId);
                            ?>
                            <li class="item" id="item-<?php echo $_product->getId() ?>">
                                <a id="<?php echo $_product->getId() ?>" href="<?php echo $productUrl; ?>"
                                   class="product-image"><img id="img-<?php echo $_product->getId() ?>"
                                                           src="<?php echo $this->helper('catalog/image')->init($_product, 'small_image')->resize(376, 490); ?>"
                                                           width="376" height="490"
                                                           alt="<?php echo $this->stripTags($this->getImageLabel($_product, 'image'), null, true) ?>"/></a>
                                <div class="list-mt-w">
                                    <h2 id="<?php echo $_product->getId() ?>" class="product-name">
                                        <a id="product-name-<?php echo $_product->getId() ?>" href="<?php echo $productUrl; ?>"
                                           title="<?php echo $this->stripTags($_product->getName(), null, true) ?>"><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?></a>
                                    </h2>
                                    <div class="actions">
                                        <div class="priceCategory" id="default-price-<?php echo $_product->getEntityId(); ?>"><p><?= $this->getPriceHtml($_product) ?></p></div>                 
                                        
	                                    <div style="display:none;">
	                                        <span id="link-qv-<?php echo $_product->getId(); ?>"><?php echo $quickViewUrl; ?></span>
	                                        <span id="link-pv-<?php echo $_product->getId(); ?>"><?php echo $productUrl; ?></span>
	                                    </div>
                                        <?php 
                                               $check = true;
                                               if($_test == 1)
                                                $check = $_product->getIsSalable();
                                               else 
                                                $check = $_product->getIsSalable2();
                                         ?>
                                        <?php if ($check): ?>
                                            <?php if ($_product->getTypeId() == 'configurable'): ?>
                                                <img id="loading-<?php echo $_product->getId() ?>" style="display:none;" src="<?php echo $mediaUrl . 'loading.gif'; ?>"/>
                                                <div class="super_attribute" id="super-attribute-<?php echo $_product->getId() ?>">                                                    
                                                    <?php 
                                                    $productId = $_product->getId();
                                                    $optionsValues = $this->getIcons($productId);  
                                                    if(!empty($optionsValues)):
                                                    $attribute_code = $optionsValues['code'];
                                                    $attribute_label = $optionsValues['label'];  
                                                    ?>
                                                    <div id="list-<?php echo $productId;?>" style="display: none;"><?php echo json_encode($optionsValues);?></div>
                                                    <div id="list-img-<?php echo $productId;?>" style="display:none">0</div>
                                                    <div id="color-option" class="color-icon">
                                                        <span>
                                                            <?php echo $attribute_label; ?>: 
                                                        </span>
                                                    </div>    
                                                    <ul id="color-icons-<?php echo $productId;?>" data-product_id="<?php echo $productId;?>">
                                                        <?php 
                                                        $j=0; 
                                                        $i=0;
                                                        $firstOption = '';
                                                        foreach ($optionsValues['value'] as $option): ?>  
                                                            <?php                                                            
                                                            $optionId = $option[$attribute_code];
                                                            $optionLb = $option[$attribute_code . "_value"];
                                                            $simple_id = $option['child_id'];  
                                                            if($j==0) $firstOption = $optionId;
                                                            $j++;
                                                            ?>
                                                            <li data-id="<?php echo $simple_id ?>"
                                                            	id="color-icon-<?php echo $simple_id ?>"
                                                                style="background: url('<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA) . 'amconf/images/' . $optionId . '.jpg'; ?>');width: 21px; height: 22px;" 
                                                                class="colorSelector tipped-create <?php echo ($i==0)?" active":""; $i++;?>" value="<?php echo $optionId ?>" 
                                                                title="<?php echo $optionLb ?>" >
                                                                <div style="display: none">
                                                                      <span id="img-<?php echo $simple_id; ?>"></span>
                                                                      <span id="price-<?php echo $simple_id; ?>"></span>
                                                                </div>
                                                            </li>            
                                                    <?php endforeach; ?>
                                                    </ul>                                                   
                                                    <?php endif;?>
                                                </div>
                                                
                                               <?php //allure code start?>
                                               <?php 
                                                    $customOptions = $this->getCustomOptions($productId);
                                               ?>
                                               <?php if(count($customOptions)):?> 
                                               <?php foreach ($customOptions as $_option):?>
                                               <?php if(strtolower($_option->getTitle()) == "post length"):?>
                                               <dl id="mt-post-length-<?php echo $productId;?>" class="last">
													<dt style="font-size: 13px;font-weight: normal;width: 48%;float: left;padding-left: 67px;">
														<label style="font-weight: normal;" class="required"><em>*</em><?php echo $_option->getTitle()?></label>
													</dt>
                                                    <dd class="last" style="margin-bottom: 10px;width: 48%;float: left;padding-right: 60px;">
                                                        <div class="input-box">
                                                            <select style="width: 90px;color:#000;font-size: 10px;" 
                                                            	name="options[<?php echo $_option->getId()?>]" data-option-id="<?php echo $_option->getId()?>" id="custom-option-select-<?php echo $productId?>" 
                                                            	class=" required-entry product-custom-option" >
                                                            	<?php foreach($_option->getValues() as $_value):?>
                                                            	<option value="<?php echo $_value['option_type_id']?>"><?php echo $_value['title']?></option>
                                                            	<?php endforeach;?>
                                                            </select>
                                                        </div>
                                                    </dd>
                                              </dl>
                                              <?php endif;?>
                                              <?php endforeach;?>  
                                              <?php endif;?>
                                              <?php //allure code end?>
                                              
                                              
                                                
                                                <?php if ($this->helper('wishlist')->isAllow()) : ?>
                                                    <a onclick="addProductToWishlist(this)" data-product="<?php echo $productId?>" data-redirect-url="<?php echo $this->getUrl("myaccount")."#wishlist";?>" data-href="<?php echo $this->helper('wishlist')->getAddUrl($_product); ?>" class="button link-wishlist glyphicon glyphicon-star">
                                                        <span><?php echo $this->__('Add to Wishlist') ?></span>
                                                    </a>
                                                <?php endif; ?>
                                                
                                                <?php //hiding becuase of paret child?>
                                               
                                                <a class="button btn-directcart glyphicon glyphicon-shopping-cart"
                                                   id='product-quickview-<?php echo $_product->getId() ?>'
                                                   href="<?php echo $_product->getProductUrl(); ?>"
                                                   data-id='<?php echo $_product->getId() ?>'
                                                   data-url="<?php echo Mage::helper('checkout/cart')->getAddUrl($_product)?>"
                                                   title="<?php echo $this->__('Add to Cart') ?>"><span><?php echo $this->__('Add to Cart') ?></span></a>
                                                <!-- <a class="fancybox fancybox.iframe button btn-quickview"
                                                   id='product-quickview-<?php echo $_product->getId() ?>'
                                                   href="<?php echo $quickViewUrl; ?><?php if($firstOption) echo "?optionId=$firstOption";?>"
                                                   title="<?php echo $this->__('quick view') ?>"><span><?php echo $this->__('quick view') ?></span></a> -->
                                            <?php else: ?>

                                                <a class="button glyphicon glyphicon-shopping-cart"
                                                   id='product-quickview-<?php echo $_product->getId() ?>'
                                                   href="<?php echo $_product->getProductUrl(); ?>"
                                                   title="<?php echo $this->__('Add to Cart') ?>"><span><?php echo $this->__('Add to Cart') ?></span></a>
                                                <!-- <a class="fancybox fancybox.iframe button btn-quickview"
                                                   id='product-quickview-<?php echo $_product->getId() ?>'
                                                   href="<?php echo $quickViewUrl; ?>"
                                                   title="<?php echo $this->__('quick view') ?>"><span><?php echo $this->__('quick view') ?></span></a> -->
                                            <?php endif; ?>
                                        <?php else: ?>
                                            <p class="availability out-of-stock"><span><?php echo $this->__('Out of stock') ?></span></p>
                                        <?php endif; ?>
                                    </div>
                                </div>
                            </li>
        				<?php endforeach ?>
                    </ul>
                    <script type="text/javascript">
                        jQuery(document).ready(function(){
                            //productItemSwatchBinding('ul.products-grid');
                        });
                        decorateGeneric($$('ul.products-grid'), ['odd', 'even', 'first', 'last']);
                    </script>
                    <?php endif; ?>

                <div class="toolbar-bottom">
    				<?php echo $this->getToolbarHtml() ?>
                </div>
            </div>
        </div>
    </div>
<?php endif; ?>
<script>

    //productItemSwatchBinding('ul.products-grid');
    //productItemSwatchBinding('ul.products-grid2');

    jQuery(document).ready(function($) {

        initSwatches();

        $( document ).ajaxComplete(function (){
            //productItemSwatchBinding('ul.products-grid');
            //productItemSwatchBinding('ul.products-grid2');
        });
        jQuery('.price-box').show();
        function resizeWindow() {
            var products = jQuery("#productsContainer ul.products-grid li.item").size();

            var visibleWidth = jQuery(window).width() - 40;
            var itemdWidth = jQuery("#productsContainer ul:first li:first").width() + 9;

            var rendered_products = products * itemdWidth;

            var itemsPerRow = Math.floor(visibleWidth / itemdWidth);

            jQuery('#productsContainer ul.products-grid').css('width', itemsPerRow * itemdWidth);
            if (products < itemsPerRow) {
                jQuery('#productsContainer .products-grid').css('text-align', 'center');
            }
            return true;
        }

        resizeWindow();
        jQuery(window).bind("resize", resizeWindow);

        function resizeWindow2() {
            var products = jQuery("#productsContainer ul.products-grid2 li.item").size();

            var visibleWidth = jQuery(window).width() - 40;
            var itemdWidth = jQuery("#productsContainer ul:first li:first").width() + 13;

            var rendered_products = products * itemdWidth;

            var itemsPerRow = Math.floor(visibleWidth / itemdWidth);

            jQuery('#productsContainer ul.products-grid2').css('width', itemsPerRow * itemdWidth);
            if (products < itemsPerRow) {
                jQuery('#productsContainer .products-grid2').css('text-align', 'center');
            }
            return true;
        }

        resizeWindow2();
        jQuery(window).bind("resize", resizeWindow2);

        /* Add tooltip for color icon*/
        // jQuery('.colorSelector').each(function(){
        //     var li_id = jQuery(this).attr('id');  
        //     var li_title = jQuery(this).attr('title'); 
        //     Tipped.create(jQuery("#"+li_id), li_title, {
        //             skin: 'customTiny',
        //             showOn: ['click', 'mouseover']
        //         });
        // });  
    });

    jQuery.noConflict();
    jQuery('a.btn-quickview').attr('rel', 'gallery').fancybox({
        openEffect: 'none',
        closeEffect: 'none',
        nextEffect: 'none',
        prevEffect: 'none',
        padding: 0,
        mouseWheel: false,
        scrolling: 'no',
        loop: false,
        wrapCSS: 'fancybox-sample-size',
        helpers: {
            title: null
        },
        margin: [20, 60, 20, 60], // Increase left/right margin
        width: 785,
        minWidth: 785,
        maxWidth: 785,
        minHeight: 510,
        height: 510,
        afterLoad: function(current, previous) {

            jQuery('.fancybox-iframe').attr('scrolling', 'no');
            if (current.href == jQuery("div.category-products ul li:first-child div.actions a.btn-quickview").attr('href')) {
                jQuery('.fancybox-outer').append('<a href="javascript: void(0);" style="opacity: 0.5" class="fancybox-nav fancybox-prev first_preview" title=""><span></span></a>');
            } else if (current.href == jQuery("div.category-products ul li:last-child div.actions a.btn-quickview").attr('href')) {
                jQuery('.fancybox-outer').append('<a href="javascript: void(0);" style="opacity: 0.5 " class="fancybox-nav fancybox-next last_next" title=""><span></span></a>');
            }
        }
    });


    //allure code start
    function addProductToWishlist(evt){
    	var data = {};
    	var supArr = {};
    	var custOpArr = {};
        var url 					= jQuery(evt).attr("data-href");
        url = url.replace('wishlist/index', 'ajaxwishlist/index');
        //.replace('https://', '//');
        var redirectUrl = jQuery(evt).attr("data-redirect-url");
        var metal   				= 209;
        var productId 				= jQuery(evt).attr("data-product");
        var superAttr 				= jQuery("#super-attribute-"+productId);
        var customOpSelect			= jQuery("#custom-option-select-"+productId);

        if(superAttr.length){
        	 var superAttrVal 			= jQuery("#color-icons-"+productId+" .active").attr("value");
        	 supArr[metal] 			    = superAttrVal;
        	 data['super_attribute'] 	= supArr;
        }

        if(customOpSelect.length){
        	var custName				= customOpSelect.attr("name");
            var custOptId				= customOpSelect.attr("data-option-id");
            var custVal 				= customOpSelect.val();
            custOpArr[custOptId] 	    = custVal;
            data['optionid'] 			= custVal;
            data['options'] 			= custOpArr;
        }
        
        data['qty'] = 1;

        jQuery.ajax({
             url: url,
             dataType: 'json',
             type: 'post',
             data: data,
             success: function (data) {               
                 if (data.status == 'ERROR') {
                     if(data.message == 'login'){
                         window.location.href = '<?php echo Mage::helper('customer')->getLoginUrl(); ?>';
                     } else {
                         alert(data.message);
                     }
                 } else {
                	 alert(data.message);
                	 window.location.href = redirectUrl;
                 }
             }
         });
    }
    //allure code end
</script>
