before_script:
  - echo 'Start Deployment'
stages:
  - alpha
  - beta
  - deploy
cloud_alpha:
  environment: staging
  stage: alpha
  tags:
    - cloud-alpha
  only:
    - bugfixes
  script:
    - mage-deploy mt
    - echo 'Deployed on Staging'

beta_teamwork:
  environment: teamwork
  stage: beta
  tags:
    - alpha
  only:
    - teamwork
  script:
    - deploy-magento mariatash
    - rm -f media && ln -s /var/www/shared/mariatash/media media
    - rm -f var && ln -s /var/www/shared/mariatash/var var
    - rm -f app/etc/local.xml && ln -s /var/www/shared/mariatash/etc/local.xml app/etc/local.xml
    - echo 'Deployed on Teamwork Staging'
    
    
beta_staging:
  environment: beta_staging
  stage: beta
  tags:
    - beta
  only:
    - master
  script:
    - deploy-magento mt-staging
    - rm -f media && ln -s /var/www/shared/mt-staging/media media
    - rm -f var && ln -s /var/www/shared/mt-staging/var var
    - rm -f app/etc/local.xml && ln -s /var/www/shared/mt-staging/etc/local.xml app/etc/local.xml
    - echo 'Deployed on Beta Staging'

deploy-cloud:
  environment: production
  stage: deploy
  tags:
    - production
  only:
    - production
  before_script:
    - git submodule sync --recursive
    - git submodule update --init --recursive
    - rm -f digital-release/config/app.php && ln -s /var/www/shared/digital-release/config/app.php digital-release/config/
    - rm -f digital-release/tmp && ln -s /var/www/shared/digital-release/tmp digital-release/
    - rm -f digital-release/logs && ln -s /var/www/shared/digital-release/logs digital-release/
    - rm -f digital-release/webroot/media && ln -s /var/www/shared/digital-release/webroot/media digital-release/webroot/
  script:
    - ln -s /usr/share/owncloud cloud
    - ln -s /var/www/shared/sitemaps
    - mage-deploy
    - echo 'Deployed on Production'